import { Callout } from "nextra-theme-docs";

## DevSecOps Project: Neftlix

![netflix](/images/article/netflix/banner.png)

DevOps va monitoringda ilg'or texnologiyalardan foydalangan holda Netflix klonini deploy qilish bo'yicha texnik qo'llanmaga xush kelibsiz. Ushbu qo'llanmada biz **Jenkins**-dan **CI/CD** dasturi sifatida, konteynerlashtirish uchun **Docker**, monitoring uchun va **Grafana**, **Prometheus** va **Node Exporter** kabi monitoring dasturlaridan foydalangan holda keng qamrovli devops sayohatini boshlaymiz.

Bizning maqsadimiz? **Netflix**-ga o'xshash streaming platformasining funksionalligini takrorlash, shu bilan birga mustahkam deployment amaliyotlari, qat'iy xavfsizlik choralari va tizim ishlashini sinchkovlik bilan kuzatish.

Ushbu qo'llanma davomida biz zaifliklarni skanerlash uchun **Trivy**, kod sifatini tahlil qilish uchun **Sonarqube ** va xavfsizlikni baholash uchun** OWASP Dependency Check** kabi dasturalarning uzluksiz integratsiyasini(CI continuous integration) ta'minlab, ushbu ilovani ishga tushirish va deploy qilish uchun zarur bo'lgan murakkab bosqichlarni ko'rib chiqamiz.

Ushbu loyiha Ubuntu servernini sozlashdan boshlanadi, u yerda biz **Jenkins**, **Docker** va **Node.js**, **Sonarqube Scanner** va **JDK** kabi muhim plaginlarni o'rnatamiz va sozlaymiz. Bundan tashqari, biz kino va teleko'rsatuv ma'lumotlarini olish uchun asosiy komponent bo'lgan **TMDB API** integratsiyasini o'rganamiz.

Deploymentni kuchaytirish uchun biz **Prometheus** va **Grafana**-ni o'rnatish, **Jenkins** ichida **Prometheus** plaginlarini o'rnatish va tuzilish holati va tizim ogohlantirishlari haqida tezkor xabardor bo'lishni ta'minlash uchun elektron pochta xabarnomalarini o'rnatish orqali monitoringga kirib boramiz.

Doimiy takomillashtirish va xavfsizlikka e'tibor qaratgan holda, biz ilovamizdagi har qanday zaifliklarni aniqlash va yumshatishni kafolatlaydigan **OWASP Dependency Check** dasturini qo'shish bo'yicha sizni sinchkovlik bilan yo'naltiramiz.

Va nihoyat, biz Netflix klonimiz uchun kengaytiriladigan va bardoshli infratuzilmani ta'minlab, Docker imagelarini yaratish, ularni docker registryga psuh qilish va serverimizda ilovamizni deploy qilish va domen ulahs orqali sayohatimizni yakunlaymiz.

Ushbu qo'llanma zamonaviy DevOps muhitida murakkab ilovalarni qo'llashni amaliy tushunishga intilayotgan ishqibozlar va mutaxassislar uchun keng qamrovli rejani taqdim etishga qaratilgan. **CI/CD**, konteynerlashtirish va ishonchli monitoringning eng yaxshi amaliyotlarini qamrab olgan holda ushbu deploymentni muvaffaqiyatli takrorlash imkonini berish uchun har bir qadam diqqat bilan batafsil bayon etilgan.

Keling, ushbu texnik sayohatni birgalikda boshlaymiz va Netflix-ga o'xshash striming platformangizni jonlantiramiz, u eng yaxshi deployment amaliyoti va mustahkam monitoring ekotizimiga ega.

<Callout type="info" emoji="">
**Mundarija**

* [Ubuntu 20.04 server sozlash](#ubuntu-2004-server-sozlash)

* [Jenkins o'rnatish, sozlash va domen ulash](#jenkins-ornatish-sozlash-va-domen-ulash)

* [Docker, Trivy o'rnatish va SonarQubeni docker orqali o'rnatish, domen ulash](#docker-trivy-ornatish-va-sonarqubeni-docker-orqali-ornatish-domen-ulash)

* [TMDB API key olish](#tmdb-api-key-olish)

* [Prometheus va Grafana o'rnatish, tizimni monitoring qilish](#prometheus-va-grafana-ornatish-tizimni-monitoring-qilish)

* [Jenkinsga prometheus plagini o'rnatish va monitoring qilish](https://devops-journey.uz/tutorials/article/netflix-deploy#jenkinsga-prometheus-plagini-ornatish-va-monitoring-qilish)

* [Jenkinsga email(gmail) integratsiya qilish](https://devops-journey.uz/tutorials/article/netflix-deploy#jenkinsga-emailgmail-integratsiya-qilish)

* [Jenkinsga Sonarqube Scanner, OWASP Dependency Check, JDK va Node.js pluginlarini o'rnatish va sozlash](https://devops-journey.uz/tutorials/article/netflix-deploy#jenkinsga-sonarqube-scanner-owasp-dependency-check-jdk-va-nodejs-pluginlarini-ornatish-va-sozlash)

* Jenkinsda birinchi CI pipeline yozish

* Jenkins pipelinega Docker image yaratish va Docker Registryga push qiladigan bosqich qo'shish

* Finish. To'liq jarayonni avtomatlashtirish uchun Jenkins pipeline yozamiz va Netflix loyihamizni production uchun tayyorlaymiz.
</Callout>

## Ubuntu 20.04 server sozlash

Loyihani boshlash uchun bizga minmum 1ta server maksimum  3ta server kerak bo'ladi.

Minimum Server talabi

<Callout type="info" emoji="">
**Minimum Server talabi**

| OS            | RAM            | CPU           | Xotira       | Static IP |
| ------------- | -------------- | ------------- |------------- | --------- |
| Ubuntu 20.04  | 8GB            | 4vCPU 2 core  | 150GB        | Ha kerak  |

Eslatib o'tamiz ushbu loyihani o'zingizda sinab test qilib ko'rish uchun bu minumum server talabi. Agar siz buni production uchun ishlatmoqchi bo'lsangiz loyiha va sizning talablaringizga qarab bu ko'satkichlar o'zgaradi

</Callout>

Server olganingizdan keyin `ssh` bilan serverga kirib yangilab olamiz

```bash
sudo apt update && sudo apt upgrade -y
```

Kerakli dasturlarni o'rnatib olamiz

```bash
sudo apt install git nano zip unzip wget apt-transport-https gnupg lsb-release -y
```
Serverni yangilab kerakli dasturlarni o'rnatib olganimizdan keyin keyingi bosqichga Jenkins o'rnatishga o'tsak bo'ladi.

## Jenkins o'rnatish, sozlash va domen ulash

**Jenkins**-ni o'rnatish sizning loyihangiz uchun Continuous Integration/Continuous Deployment**(CI/CD)** pipeline o'rnatishda muhim qadamdir. Jenkins - bu ilovalarni yaratish, sinovdan o'tkazish va deployment uchun ishlatiladigan mashhur avtomatlashtirish serveri.

Jenkins o'rnatish bo'yicha to'liq qo'llanmani [Linux Serverlarga Jenkins o'rnatish](https://devops-journey.uz/guides/ci-cd/jenkins-ornatish) qo'llanmasida topishingiz mumkin. Yoki keling qisqa o'rnatishni boshlaymiz.

**1. Java o'rnatish**

Jenkins ishga tushirish uchun Java-ni talab qiladi, ammo ba'zi distributivlar standart bo'yicha buni o'z ichiga olmaydi va ba'zi Java versiyalari Jenkins bilan mos kelmaydi. Siz foydalanishingiz mumkin bo'lgan bir nechta Java ilovalari mavjud. OpenJDK hozirda eng ommabop, biz undan ushbu qo'llanmada foydalanamiz. Debian apt repositoriyalarini yangilang, OpenJDK 17 ni o'rnating va buyruqlar bilan o'rnatishni tekshiring:

```bash
sudo apt update
sudo apt install openjdk-17-jre
java -version
```

**2. LTS versiyali jenkinsni o'rnatish**

LTS (Uzoq muddatli qo'llab-quvvatlash) versiyasi har 12 haftada muntazam releaselar oqimidan o'sha vaqt uchun barqaror release sifatida tanlanadi. U debian-stable apt repositorydan o'rnatilishi mumkin.

```bash
curl -fsSL https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key | sudo tee \
  /usr/share/keyrings/jenkins-keyring.asc > /dev/null
echo deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] \
  https://pkg.jenkins.io/debian-stable binary/ | sudo tee \
  /etc/apt/sources.list.d/jenkins.list > /dev/null
sudo apt-get update
sudo apt-get install jenkins
```

**3. Jenkinsni ishga tushirish**

Jenkinsni serviceni yoqish start berish va ishlayotgan statusni ko'rish uchun quyidagi buyruqlardan foydalaning.

```bash
sudo systemctl enable jenkins
sudo systemctl start jenkins
sudo systemctl status jenkins
```
**4. Jenkins qulfini ochish**

Yangi Jenkins misoliga birinchi marta kirganingizda, uni avtomatik ravishda yaratilgan parol yordamida qulfdan chiqarish so'raladi. http://localhost:8080 (yoki uni o'rnatishda Jenkins uchun qaysi portni sozlagan bo'lsangiz) sahifasini ko'rib chiqing va `Unlock Jenkins` sahifasi paydo bo'lguncha kuting.

![jenkins](/images/ci-cd/1.jpg)

parolni ko'rish uchun jenkisn parol qayerda turganini ko'rsatib parol fayliga yo'l ko'rstaib qo'yadi yani `/var/lib/jenkins/secrets/initialAdminPassword`. parolni olish quyidagi buyruqdan foydalanamiz.

```bash
sudo cat /var/lib/jenkins/secrets/initialAdminPassword
```
Bu buyruq `sudo cat /var/lib/jenkins/secrets/initialAdminPassword` parolni konsolda chop etadi. Terminaldan 32 belgidan iborat alphanumeric paroldan nusxa oling va uni Administrator paroli maydoniga joylashtiring, so'ng `Continue` tugmasini bosing. Keyingi ekranda tavsiya etilgan plaginlarni o'rnatish yoki maxsus plaginlarni tanlash imkoniyati mavjud:

![jenkins](/images/ci-cd/2.png)

Biz `suggested plugins` opsiyasini bosamiz, bu darhol o'rnatish jarayonini boshlaydi.

![jenkins](/images/ci-cd/3.png)

O'rnatish tugallangach, sizdan birinchi `Admin User` o'rnatish so'raladi. Bu bosqichni o'tkazib yuborish va yuqoridagi boshlang'ich parol yordamida administrator sifatida davom etish mumkin, lekin foydalanuvchi yaratishga biroz vaqt ajratamiz.

![jenkins](/images/ci-cd/4.png)

Siz Jenkins instance uchun afzal qilingan URL manzilini tasdiqlashingizni so'raydigan Instance Configuration sahifasini olasiz. Serveringiz uchun domen nomini yoki serveringizning IP manzilini tasdiqlang:

![jenkins](/images/ci-cd/5.png)

Tegishli ma'lumotlarni tasdiqlaganingizdan so'ng, `Save and Finish` tugmasini bosing. Siz `"Jenkins is Ready!"` degan tasdiqlash sahifasini olasiz:

![jenkins](/images/ci-cd/6.png)

Asosiy Jenkins boshqaruv paneliga tashrif buyurish uchun `Start using Jenkins` tugmasini bosing:

![jenkins](/images/ci-cd/8.png)

Shu nuqtada siz Jenkins-ni muvaffaqiyatli o'rnatdingiz. Keyingi qismga o'tamiz

**5. Nginx, certbot o'rnatish va domen ulab ssl sertifikat olish**

Serverimizga Jenkins o'rnatdik va uni dastlablki holat uchun zolab oldik lekin biz har doim jenkinsga kirganimizda serverimiz IP mazili va jenkins portini kiritib yozishimiz kerak bu yaxshimas lekin bunga kirish oson bo'lishi va xavfsiz bo'lishi uchun domen ulab ssl sertificat olamiz.

**6.Nginx va certbot o'rnatish uchun quyidagi buyruqdan foyalanasiz.**

```bash
sudo apt update
sudo apt install nginx
sudo apt install certbot python3-certbot-nginx
```
jenkinsga domen ulash uchun nginx configuratsiya qilishimiz kerak. `/etc/nginx/sites-available/` jildida domenimiz uchun configuratsiya fayl ochamiz. MAsalan domenimiz `jenkins.samidello.uz`.

```bash /jenkins.samidello.uz/
sudo nano /etc/nginx/sites-available/jenkins.samidello.uz
```
fayl nano matn muhrarrida ochilganidan keyin quyidagi Nginx configuratsiyani joylashtiring.

```bash filename="/etc/nginx/sites-available/jenkins.samidello.uz"
server {
    listen 80;
    server_name jenkins.samidello.uz;

    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```
**Nginx**dagi ushbu konfiguratsiya bloki `80`-portda `jenkins.samidello.uz` domeni orqali Jenkinsga kirish uchun `reverse proxy-`serverni o'rnatish uchun zarur. Ushbu Nginx configuratsiyani qismlarga bo'lib ko'rib chiqamiz.

```bash /server/ /listen/ /server_name/
server {
    listen 80;
    server_name jenkins.samidello.uz;
```
* `server` Bu blok Nginx-da server konfiguratsiya blokining boshlanishini bildiradi.

* `listen 80` Nginx standart **HTTP** porti bo'lgan **80**-portda tinglaydi(listen).

* `server_name jenkins.samidello.uz;` Ushbu server blokiga mos keladigan domen nomi yoki nomlarini belgilaydi. Bu holda, u `jenkins.samidello.uz` ga o'rnatiladi.

```bash /proxy_set_header/ /location/ /proxy_pass/
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
```
* `location /` Bu blok ushbu server bloki boshqaradigan joyni belgilaydi. Bunday holda, u ildiz(root) `/` ga o'rnatiladi, shuning uchun `jenkins.samidello.uz` saytiga har qanday so'rov ushbu blok tomonidan ko'rib chiqiladi.

* `proxy_pass http://localhost:8080;` Bu qator Jenkins ishlayotgan server backend serverini belgilaydi. Nginx `jenkins.samidello.uz` saytiga kelgan so'rovlarni Jenkins ishlashi kutilayotgan `http://localhost:8080` manziliga yo'naltiradi.

* `proxy_set_header` Bu qatorlar proksi-server so'rovi bilan birga uzatiladigan **header**halarni o'rnatadi. Ular asl client IP, host, protokol va boshqalar haqidagi ma'lumotlarni o'z ichiga oladi. Bu Jenkinsga Nginx orqali kelgan so'rovlarni to'g'ri bajarishga yordam beradi.

Ushbu konfiguratsiya **Nginx**-ni **Jenkins** uchun reverse proxy-server sifatida o'rnatadi. **80**-portda `jenkins.samidello.uz` manziliga Nginx tomonidan qabul qilingan har qanday so'rov(request) **8080**-portda lokal ravishda ishlaydigan Jenkins serveriga yo'naltiriladi. Shuningdek, so'rov Jenkinsga yetib kelganida mijoz ma'lumotlari yaxlitligini saqlash uchun zarur headerlar o'rnatilishini ta'minlaydi.

**7. SSL sertifikat olish va HTTP trafikni HTTPS ga yo'naltirish**

Nginx configuratsiya uchun symbolic link yaratish
```bash
sudo ln -s /etc/nginx/sites-available/jenkins.samidello.uz //etc/nginx/sites-enabled/jenkins.samidello.uz
```
Bu buyruq `/etc/nginx/sites-available` jildida Jenkins uchun yaratgan konfiguratsiya fayli (jenkins.samidello.uz) va `/etc/nginx/sites-enabled` jildi o'rtasida symbolic link hosil qiladi. Ushbu ulanishning maqsadi Nginx serveriga siz Jenkins uchun o'rnatgan konfiguratsiyani saytlar faollashtirilgan jildda mavjud qilish orqali o'qish va foydalanish imkonini berishdir.

**Nginx konfiguratsiya sintaksisini tekshirish**
```bash
sudo nginx -t
```
Ushbu buyruq hech qanday sintaksis xatosi yo'qligiga ishonch hosil qilish uchun Nginx konfiguratsiya fayllari sintaksisini tekshiradi. Bu Nginx-ning noto'g'ri konfiguratsiyalar tufayli ishga tushmasligining oldini olish uchun muhim qadamdir.

**SSL sertifikatini olish uchun Certbot-dan foydalanish.**

```bash
sudo certbot
```
Bu buyruq Certbot ilovasini ishga tushiradi. U bepul Sertifikat organi **Let's Encrypt**dan **SSL/TLS** sertifikatini olish uchun bir qator takliflar orqali foydalanuvchi bilan o'zaro aloqada bo'ladi. Certbot sizdan SSL sertifikatini olmoqchi bo'lgan Nginx server blokini tanlashni taklif qiladi. Bunday holda, u jenkins.samidello.uz saytini domen konfiguratsiyasi sifatida aniqlaydi va sertifikat berish jarayoni bo'yicha sizga yo'l ko'rsatadi. Ko'rsatmalar xizmat shartlariga rozi bo'lishni, yangilash bildirishnomalari uchun elektron pochta manzilini taqdim etishni va **HTTP** trafigini **HTTPS**ga yo'naltirishni tanlashni o'z ichiga oladi.

## Docker, Trivy o'rnatish va SonarQubeni docker orqali o'rnatish, domen ulash

**Docker**-ni o'rnatish infratuzilmangizda bir nechta maqsadlarga xizmat qiladi, ayniqsa SonarQube-ni o'rnatish va uni domen orqali ulashda va applicationlarimzida deploy qilshimizda ishga tushirishimizda.

Keling docker o'rnatish uchun bash scriptdan foydalanamiz. `nano` matn muharrir bilan `docker.sh` nomli fayl ochib olamiz.

```bash
sudo nano docker.sh
```

Va `docker.sh` bash scriptimizga quyidagi scriptni joylashtiring

```bash filename="docker.sh"
#!/bin/bash

# Get the current username
CURRENT_USERNAME=$(whoami)

# Update and upgrade system packages
sudo apt update && sudo apt upgrade -y
# Install additional utilities
sudo apt install -y curl gnupg2 software-properties-common apt-transport-https 

# Add Docker's official GPG key:
sudo apt-get update
sudo apt-get -y install ca-certificates curl gnupg
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg

# Add the repository to Apt sources:
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update

sudo apt-get -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin docker-compose

# Adjust Docker socket permissions
sudo chmod 666 /var/run/docker.sock
sudo chown $CURRENT_USERNAME:docker /var/run/docker.sock

# Restart and enable Docker service
sudo systemctl daemon-reload
sudo systemctl restart docker
sudo systemctl enable docker
```
`docker.sh` faylimizga quyidagi scriptni joylashtirganimizdan keyin uni execute qilib ishga tushiramiz. Script avtomatik Dockerni o'rnatib kerakli permissionlarni(ruxsatlarni) beradi.

```bash
sudo chmod +x docker.sh
./docker.sh
```

Script ish tugatganidan keyin docker o'rnatilgani tekshirib ko'rishingiz mumkin. Docker muvaffaqiyatli o'rnatilganidan keyin **SonarQube Community** ni docker orqali o'rnatamiz.

SonarQube-ni o'rnatish avtomatlashtirilgan tahlilni ishlab chiqish jarayoniga integratsiyalash orqali kod sifati va xavfsizligiga proaktiv yondashuvni taqdim etadi. Bu dasturchilar guruhlariga kod bilan bog'liq muammolarni erta aniqlash, tushunish va tuzatish imkoniyatini beradi, ishonchli, xavfsiz va yuqori sifatli dasturiy mahsulotlarni yetkazib berishni ta'minlaydi. Bundan tashqari, u dasturchilar guruhida doimiy takomillashtirish, hamkorlik qilish va kodlash standartlariga rioya qilish madaniyatini rivojlantiradi.

**SonarQube**ni docker orqali quyidagi buyruq bilan o'rnatib olamiz.

```bash
docker run -d --name sonar -p 9000:9000 sonarqube:lts-community
```
Ushbu buyruq SonarQube LTS Community versiyasini `9000` portda ishga tushiradi. Serveringiz IP maznilida `9000` portga kirsangiz quyidagi SonarQube oynasi ochilishi kerak.

![netflix](/images/article/netflix/sonar1.png)

Ushbu oynada siz **Login**ga `admin` **Passowrd**ga `admin` yozib kiramiz. Keyin bizdan oldingi parolni yozishimizni va ynagi parol qo'yishimizni so'raydi va yangi parol qo'yib sozlaymiz. sizda quyidagi oyna ochilishi kerak.

![netflix](/images/article/netflix/sonar2.png)

Parolni yangilaganizdan keyin quyidagi SonarQube dashboardi ochilishi kerak.

![netflix](/images/article/netflix/sonar3.png)


### Trivy o'rnatish

**Trivy** dasturiy ta'minotni ishlab chiqish jarayonida xavfsizlik choralarini kuchaytirish uchun o'rnatilgan. Bu konteynerlar uchun maxsus ishlab chiqilgan, konteyner imagelari va fayl tizimlaridagi xavfsizlik muammolari va zaifliklarni aniqlaydigan zaiflik skaneri(vulnerability scanner). **Trivy** konteynerlashtirilgan ilovalarning ma'lum zaifliklardan xoli bo'lishini ta'minlash, xavfsizlik xatarlarini kamaytirish va deploy qilingan dasturiy ta'minotning umumiy xavfsizlik holatini yaxshilashga yordam beradi.

Keling **Trivy**ni bash script yordamida o'rnatamiz. nano matn muharriri yordamida `trivy.sh` fayl ochib olamiz.

```bash
nano trivy.sh
```

nani matn muharirir ochilganidan keyin quyidagi scriptni joylashtiramiz.

```bash filename="trivy.sh"
#!/bin/bash
sudo apt-get install wget apt-transport-https gnupg lsb-release
wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
sudo apt-get update
sudo apt-get install trivy
```

Scriptni ishga tushiramiz.

```bash
sudo chmod +x trivy.sh
./trivy.sh
```

## TMDB API key olish

**TMDB** API keyi Kino ma'lumotlar bazasidan (**The Movie Database - TMDB**) kino va teleko'rsatuv ma'lumotlariga kirish va olish uchun zarurdir. Bu ilovalarga filmlar xulosalari, translatsiya maʼlumotlari, reytinglar va Netflixʼga oʻxshash keng qamrovli filmlar streaminng platformasini yaratish uchun zarur boʻlgan boshqa metamaʼlumotlar kabi tafsilotlarni olish imkonini beradi.

TMDB API key olish uchun uning saytiga kirishimiz kerak. [themoviedb.org(https://www.themoviedb.org/)]

![netflix](/images/article/netflix/tmdb1.png)

**TMDB**da akkountingiz bo'lsa akkountizga kirasiz yoki akkount ochib olasiz. Quyidagi oynadan `Settings` bo'limga o'tib keyin `API` bo'limga kirasiz.

![netflix](/images/article/netflix/tmdb2.png)

`API` bo'limga kiramiz.
![netflix](/images/article/netflix/tmdb3.png)

`Create` dan API key generatsiya qilib olamiz.
![netflix](/images/article/netflix/tmdb4.png)

Shartlarni qabul qilishingiz kerak. `Accept`
![netflix](/images/article/netflix/tmdb7.png)

Ma'lumotlarni to'ldirib chiqamiz.

![netflix](/images/article/netflix/tmdb6.png)

Ma'lumotlarni to'ldirib chiqagnimizdan keyin quyidagi oynada bizga API key beradi. `API Key`
![netflix](/images/article/netflix/tmdb5.png)

API Keyni nusxalab olib qo'yamiz loyihamizda ishlatamiz.

## Prometheus va Grafana o'rnatish, tizimni monitoring qilish

Prometheus va Grafana monitoring va vizualizatsiya uchun o'rnatamiz. Prometheus turli tizimlardagi ko'rsatkichlarni(metrikalarni) to'playdi va saqlaydi, Grafana esa ushbu ko'rsatkichlarni vizualizatsiya qilish va tahlil qilish uchun foydalanuvchilarga qulay interfeysni taqdim etadi. Birgalikda ular deploy qilingan ilovalar va infratuzilmani samarali monitoring qilish, muammolarni bartaraf etish va ish faoliyatini tahlil qilish imkonini beradi.

**Prometheus** va **Grafana** o'rnatish bo'yicha batafsil qo'llanma oldinroq yozilgan shu qo'llanmadan foydalangan holda **Prometheus**, **Garafana** va **node_exporter**ni o'rnatib sozlashingiz mumkin. 

<Callout type="info" emoji="">

Prometheus, Grafana, Node Exporter o'rnatish sozlash integratsiya qilish uchun quyidagi qo'llanmadan foydalanasiz.

**Pometheus:** [Prometheus nima?](https://devops-journey.uz/tutorials/article/gnp-monitoring#prometheus-nima), [Prometheus o'ratish va sozlash](https://devops-journey.uz/tutorials/article/gnp-monitoring#prometheus-oratish-va-sozlash), [Client Nodelarini kuzatish uchun Prometheusni sozlash](https://devops-journey.uz/tutorials/article/gnp-monitoring#client-nodelarini-kuzatish-uchun-prometheusni-sozlash), [Grafana va Prometheusni integratsiya qilish](https://devops-journey.uz/tutorials/article/gnp-monitoring#grafana-va-prometheusni-integratsiya-qilish)

**Grafana:** [Grafana nima?](https://devops-journey.uz/tutorials/article/gnp-monitoring#grafana-nima), [Grafana serverini qanday o'rnatish va sozlash
](https://devops-journey.uz/tutorials/article/gnp-monitoring#grafana-serverini-qanday-ornatish-va-sozlash), [Grafana Dashboardni import qilish](https://devops-journey.uz/tutorials/article/gnp-monitoring#grafana-dashboardni-import-qilish)

**Node Exporter:** [Node Exporter-ni o'ratish va sozlash](https://devops-journey.uz/tutorials/article/gnp-monitoring#node-exporter-ni-oratish-va-sozlash)

![netflix](/images/article/netflix/grafana-dashboard1.png)

Rasmdagi **Node Exporter Full** Dashboardi `ID`si `1860` havola [Node Exporter Full](https://grafana.com/grafana/dashboards/1860-node-exporter-full/)
</Callout>

## Jenkinsga prometheus plagini o'rnatish va monitoring qilish

![netflix](/images/article/netflix/grafana-dashboard2.png)

**Jenkins**-ga Prometheus plaginini o'rnatish va monitoring qilish Jenkinsga xos ko'rsatkichlarni(metrics) to'plash va kuzatish imkonini beradi. Bu Jenkinsning ishlashi, resurslardan foydalanish va ish holatini kuzatishga yordam beradi, Jenkinsning sog'lig'ini yaxshiroq ko'rish imkonini beradi va CI/CD pipelinedagi muammolarni aniqlash va hal qilishda yordam beradi.

Jenkinsga prometheus plagini o'rnatish uchun Jenkinsga kirib **->** `Manage Jenkins` **->** `Plugins` bo'limga kiramiz.

![netflix](/images/article/netflix/jenkins1.png)

![netflix](/images/article/netflix/jenkins2.png)

Prometheus plagini o'rnatilganidan keyin **->** `Manage Jenkisn` **->** `System` ga kirib Prometheus bo'limini topamiz va quyidagicha to'ldirib `Apply` bosib `Save` qilamiz.

![netflix](/images/article/netflix/jenkins3.png)

Plaginni o'rnatib sozlab bo'lganimzidan keyin prometheusga jenkins exporterni qo'shib sozlaymiz. `/etc/prometheus/prometheus.yml` fayliga quyida konfiguratsiyani qo'shib qo'yamiz.

```yaml
nano /etc/prometheus/prometheus.yml
```

```yaml filename="/etc/prometheus/prometheus.yml" /8080/ /prometheus/ /jenkins/
  - job_name: 'jenkins'
    metrics_path: '/prometheus'
    static_configs:
      - targets: ['0.0.0.0:8080']
```

`0.0.0.0:8080` bu yerda siz jenkins o'rnatilgan serveringiz **IP** manzilini kiritasiz. Quyida to'liq `prometheus.yml` faylining to'liq ko'rinishi.

```yaml filename="/etc/prometheus/prometheus.yml" /static_configs/ /targets/
# my global config
global:
  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          # - alertmanager:9093

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: "prometheus"

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ["localhost:9090"]


  - job_name: "node_exporter"
    static_configs:
      - targets: ["localhost:9100"]

  - job_name: 'jenkins'
    metrics_path: '/prometheus'
    static_configs:
      - targets: ['0.0.0.0:8080']
```

Configuratsiyani yozib sozlab bo'lganimzidan keyin uni `promtool` bilan tekshirib ko'ramiz.

```bash
promtool check config /etc/prometheus/prometheus.yml
```

```txt filename="Natija"
Checking /etc/prometheus/prometheus.yml
 SUCCESS: /etc/prometheus/prometheus.yml is valid prometheus config file syntax
```
Configuratsiya to'gri yozilgan bo'lssa sizda quyidagi natija chiqishi kerak agar xato chiqsa configuratsiyani yana bir bor ko'rib chiqing.
**prometheus**ni restart qilib qayta ishga tushirishimiz kerak.

```bash
sudo systemctl restart prometheus
```

`http://0.0.0.0:9090/targets` quyida siz IP manzilingiz bilan prometheusga kirib targets bo'limga kirsangiz `job="jenkins"` chiqishi kerak.

Grafana orqali Jenkins metrikalarni vizualizatsiya qilish uchun Jenkins dashboard import qilamiz. 

![netflix](/images/article/netflix/grafana-dashboard2.png)

Rasmdagi Dashboard `ID`si `9964` [Jenkins: Performance and Health Overview](https://grafana.com/grafana/dashboards/9964-jenkins-performance-and-health-overview/)
Gfanaga dashboard import qilish bo'yicha qo'llanma yozilgan [Grafana Dashboardni import qilish](https://devops-journey.uz/tutorials/article/gnp-monitoring#grafana-dashboardni-import-qilish) qo'llanmasidan foydalanasiz.

## Jenkinsga email(gmail) integratsiya qilish

**Jenkins** va plaginlarni sozlash bilan elektron pochta integratsiyasi avtomatik bildirishnomalar(notification) va build statusi, nosozliklar yoki tizim muammolari haqida ogohlantirishlarga imkon beradi. Bu ishlab chiqish guruhi bilan o'z vaqtida aloqa o'rnatishni ta'minlaydi, CI/CD pipelinedagi mumkin bo'lgan muammolarga tezkor javob beradi va jamoa a'zolari o'rtasida samarali hamkorlikni osonlashtiradi.

**Jenkinsni** **Gmail** bilan integratsiyalash **Trivy** sttausi va loglarni elektron pochta orqali bildirishnomalar sifatida yuborish imkonini beradi. Ushbu sozlash jamoaga **Trivy** skanerlashlari, shu jumladan holat(status) yangilanishlari va batafsil loglarni bevosita **Gmail** pochta qutisiga zudlik bilan olishini ta'minlaydi. U aloqani soddalashtiradi va jamoani **Trivy** tomonidan aniqlangan xavfsizlik skanerlari va zaifliklar haqida real vaqt rejimida xabardor qiladi, bu esa yuzaga kelishi mumkin bo'lgan muammolarga faol javob berishga yordam beradi.

Jenkinsni email bilan inetgratsiya qilishimiz uchun `Email Extension Template` plagini o'rnatib olishimiz kerak. **->** `Manage Jenkins` **->** `Plugins` **->** `Available plugins`.  Plaginlardan [`Email Ext Recipients Column`](https://plugins.jenkins.io/email-ext-recipients-column/) plagini o'rnatib olamiz

![netflix](/images/article/netflix/jenkins3.png)

[myaccount.google.com](https://myaccount.google.com/security)-dan `Security` bo'limga o'ting va **2-Step Verification** yoqilganligini tekshiring yoqilmagan bo'lsa yoqing. **2-Step Verification**-ni yoqganizdan keyin qidiruvdan `app` deb qidiring quyidagicha ko'rinishi kerak, `App passwords` ga kiring.

![netflix](/images/article/netflix/gmail1.png)

**App passwords**ga kirganimzidan keyin `App name`-ga ilovalamiz nomini kiritamiz `Jenkins`. kiritganimizdan keyin `Create` bosib parol app password yaratib olamiz va nusxalab olib qo'yamiz.
![netflix](/images/article/netflix/gmail2.png)

![netflix](/images/article/netflix/gmail3.png)

Jenkinsga E-mail notification uchun gmail bilan integratsiya qilamiz. Birinchi navbatda credentialslarni qo'shib olamiz. **->** `Manage Jenkins` **->** `Credentials`-ga kirib  `Add credentials`ga o'tamiz.

![netflix](/images/article/netflix/secret1-new.png)

![netflix](/images/article/netflix/secret2-new.png)

ushbu qismni rasmda ko'rsatilgandek konfiguratsiya qilib olamiz. 

* **Kind:** username with password
* **Username:** mygmail.com(hozir 2 step verification yoqib app paswword olgan emailimiz)
* **Password:** bu yerga Google bergan app passwordni qo'yamiz.

Hammasini to'gri to'ldirib chiqganimzidan keyin `Create` bosib credentials yartatib olamiz. Mail credentials yaratib olganimizdan keyin **->** `Manage Jenkins` **->** `System` bo'limga o'tib **E-mail Notification** qismini topib olamiz varasmdagidek konfiguratsiya qilamiz.

![netflix](/images/article/netflix/gmail4-new.png)

* **SMTP Server: ** smtp.gmail.com (Gmail bilan integratsiyta qilayotganimiz uchun gmail SMT serveridan foydalanamiz)
* **Use SMTP Authentication:** ga emailimiz va parolini yozamiz
* **SMTP Port:** 465(gmail SMTP severi standart porti)

`System` dan **Extented E-mail Notification** qismini topib olamiz va quyidagicha konfiguratsiya qilamiz.

![netflix](/images/article/netflix/gmail5-new.png)

Triggerga **Always**

![netflix](/images/article/netflix/gmail6-new.png)

Hammasini ko'rsartilganiday o'zingizga moslab solzab olganingizdan keyin `Apply` va `Save` bosamiz.

Email Notificationni sozlab olganimizdan keyin Jenkins pipelineda email notificationdan quyidagicha foydalanamiz.

```groovy
post {
     always {
        emailext attachLog: true,
            subject: "'${currentBuild.result}'",
            body: "Project: ${env.JOB_NAME}<br/>" +
                "Build Number: ${env.BUILD_NUMBER}<br/>" +
                "URL: ${env.BUILD_URL}<br/>",
            to: 'mygmail@gmail.com',
            attachmentsPattern: 'trivyfs.txt,trivyimage.txt'
        }
    }
```

## Jenkinsga Sonarqube Scanner, OWASP Dependency Check, JDK va Node.js pluginlarini o'rnatish va sozlash