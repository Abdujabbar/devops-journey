import { Callout } from "nextra-theme-docs";

## DevSecOps Project: Neftlix

![netflix](/images/article/netflix/banner.png)

DevOps va monitoringda ilg'or texnologiyalardan foydalangan holda Netflix klonini deploy qilish bo'yicha texnik qo'llanmaga xush kelibsiz. Ushbu qo'llanmada biz **Jenkins**-dan **CI/CD** dasturi sifatida, konteynerlashtirish uchun **Docker**, monitoring uchun va **Grafana**, **Prometheus** va **Node Exporter** kabi monitoring dasturlaridan foydalangan holda keng qamrovli devops sayohatini boshlaymiz.

Bizning maqsadimiz? **Netflix**-ga o'xshash streaming platformasining funksionalligini takrorlash, shu bilan birga mustahkam deployment amaliyotlari, qat'iy xavfsizlik choralari va tizim ishlashini sinchkovlik bilan kuzatish.

Ushbu qo'llanma davomida biz zaifliklarni skanerlash uchun **Trivy**, kod sifatini tahlil qilish uchun **Sonarqube ** va xavfsizlikni baholash uchun** OWASP Dependency Check** kabi dasturalarning uzluksiz integratsiyasini(CI continuous integration) ta'minlab, ushbu ilovani ishga tushirish va deploy qilish uchun zarur bo'lgan murakkab bosqichlarni ko'rib chiqamiz.

Ushbu loyiha Ubuntu servernini sozlashdan boshlanadi, u yerda biz **Jenkins**, **Docker** va **Node.js**, **Sonarqube Scanner** va **JDK** kabi muhim plaginlarni o'rnatamiz va sozlaymiz. Bundan tashqari, biz kino va teleko'rsatuv ma'lumotlarini olish uchun asosiy komponent bo'lgan **TMDB API** integratsiyasini o'rganamiz.

Deploymentni kuchaytirish uchun biz **Prometheus** va **Grafana**-ni o'rnatish, **Jenkins** ichida **Prometheus** plaginlarini o'rnatish va tuzilish holati va tizim ogohlantirishlari haqida tezkor xabardor bo'lishni ta'minlash uchun elektron pochta xabarnomalarini o'rnatish orqali monitoringga kirib boramiz.

Doimiy takomillashtirish va xavfsizlikka e'tibor qaratgan holda, biz ilovamizdagi har qanday zaifliklarni aniqlash va yumshatishni kafolatlaydigan **OWASP Dependency Check** dasturini qo'shish bo'yicha sizni sinchkovlik bilan yo'naltiramiz.

Va nihoyat, biz Netflix klonimiz uchun kengaytiriladigan va bardoshli infratuzilmani ta'minlab, Docker imagelarini yaratish, ularni docker registryga psuh qilish va serverimizda ilovamizni deploy qilish va domen ulahs orqali sayohatimizni yakunlaymiz.

Ushbu qo'llanma zamonaviy DevOps muhitida murakkab ilovalarni qo'llashni amaliy tushunishga intilayotgan ishqibozlar va mutaxassislar uchun keng qamrovli rejani taqdim etishga qaratilgan. **CI/CD**, konteynerlashtirish va ishonchli monitoringning eng yaxshi amaliyotlarini qamrab olgan holda ushbu deploymentni muvaffaqiyatli takrorlash imkonini berish uchun har bir qadam diqqat bilan batafsil bayon etilgan.

Keling, ushbu texnik sayohatni birgalikda boshlaymiz va Netflix-ga o'xshash striming platformangizni jonlantiramiz, u eng yaxshi deployment amaliyoti va mustahkam monitoring ekotizimiga ega.

<Callout type="info" emoji="">
**Mundarija**

* Ubuntu 20.04 server sozlash

* Jenkins o'rnatish, sozlash va domen ulash

* Docker o'rnatish va SonarQubeni docker orqali o'rnatish, domen ulash

* TMDB API key olish

* Prometheus va Grafana o'rnatish tizimni monitoring qilish

* Jenkinsga prometheus plagini o'rnatish va monitoring qilish

* Jenkinsga email(gmail) integratsiya qilish

* Jenkinsga Sonarqube Scanner, OWASP Dependency Check, JDK va Node.js pluginlarini o'rnatish va sozlash

* Jenkinsda birinchi CI pipeline yozish

* Jenkins pipelinega Docker image yaratish va Docker Registryga push qiladigan bosqich qo'shish

* Finish. To'liq jarayonni avtomatlashtirish uchun Jenkins pipeline yozamiz va Netflix loyihamizni production uchun tayyorlaymiz.
</Callout>

## Ubuntu 20.04 server sozlash

Loyihani boshlash uchun bizga minmum 1ta server maksimum  3ta server kerak bo'ladi.

Minimum Server talabi

<Callout type="info" emoji="">
**Minimum Server talabi**

| OS            | RAM            | CPU           | Xotira       | Static IP |
| ------------- | -------------- | ------------- |------------- | --------- |
| Ubuntu 20.04  | 8GB            | 4vCPU 2 core  | 150GB        | Ha kerak  |

Eslatib o'ta,iz ushbu loyihani o'zingizda sinab test qilib ko'rish uchun bu minumum server talabi. Agar siz buni production uchun ishlatmoqchi bo'lsangiz loyiha va sizning talablaringizga qarab bu ko'satkichlar o'zgaradi

</Callout>

Server olganingizdan keyin `ssh` bilan serverga kirib yangilab olamiz

```bash
sudo apt update && sudo apt upgrade -y
```

Kerakli dasturlarni o'rnatib olamiz

```bash
sudo apt install git nano zip unzip wget apt-transport-https gnupg lsb-release -y
```
Serverni yangilab kerakli dasturlarni o'rnatib olganimizdan keyin keyingi bosqichga Jenkins o'rnatishga o'tsak bo'ladi.

### Jenkins o'rnatish, sozlash va domen ulash

**Jenkins**-ni o'rnatish sizning loyihangiz uchun Continuous Integration/Continuous Deployment**(CI/CD)** pipeline o'rnatishda muhim qadamdir. Jenkins - bu ilovalarni yaratish, sinovdan o'tkazish va deployment uchun ishlatiladigan mashhur avtomatlashtirish serveri.

Jenkins o'rnatish bo'yicha to'liq qo'llanmani [Linux Serverlarga Jenkins o'rnatish](https://devops-journey.uz/guides/ci-cd/jenkins-ornatish) qo'llanmasida topishingiz mumkin. Yoki keling qisqa o'rnatishni boshlaymiz.

**1. Java o'rnatish**

Jenkins ishga tushirish uchun Java-ni talab qiladi, ammo ba'zi distributivlar standart bo'yicha buni o'z ichiga olmaydi va ba'zi Java versiyalari Jenkins bilan mos kelmaydi. Siz foydalanishingiz mumkin bo'lgan bir nechta Java ilovalari mavjud. OpenJDK hozirda eng ommabop, biz undan ushbu qo'llanmada foydalanamiz. Debian apt repositoriyalarini yangilang, OpenJDK 17 ni o'rnating va buyruqlar bilan o'rnatishni tekshiring:

```bash
sudo apt update
sudo apt install openjdk-17-jre
java -version
```

**2. LTS versiyali jenkinsni o'rnatish**

LTS (Uzoq muddatli qo'llab-quvvatlash) versiyasi har 12 haftada muntazam releaselar oqimidan o'sha vaqt uchun barqaror release sifatida tanlanadi. U debian-stable apt repositorydan o'rnatilishi mumkin.

```bash
curl -fsSL https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key | sudo tee \
  /usr/share/keyrings/jenkins-keyring.asc > /dev/null
echo deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] \
  https://pkg.jenkins.io/debian-stable binary/ | sudo tee \
  /etc/apt/sources.list.d/jenkins.list > /dev/null
sudo apt-get update
sudo apt-get install jenkins
```

**3. Jenkinsni ishga tushirish**

Jenkinsni serviceni yoqish start berish va ishlayotgan statusni ko'rish uchun quyidagi buyruqlardan foydalaning.

```bash
sudo systemctl enable jenkins
sudo systemctl start jenkins
sudo systemctl status jenkins
```
**4. Jenkins qulfini ochish**

Yangi Jenkins misoliga birinchi marta kirganingizda, uni avtomatik ravishda yaratilgan parol yordamida qulfdan chiqarish so'raladi. http://localhost:8080 (yoki uni o'rnatishda Jenkins uchun qaysi portni sozlagan bo'lsangiz) sahifasini ko'rib chiqing va `Unlock Jenkins` sahifasi paydo bo'lguncha kuting.

![jenkins](/images/ci-cd/1.jpg)

parolni ko'rish uchun jenkisn parol qayerda turganini ko'rsatib parol fayliga yo'l ko'rstaib qo'yadi yani `/var/lib/jenkins/secrets/initialAdminPassword`. parolni olish quyidagi buyruqdan foydalanamiz.

```bash
sudo cat /var/lib/jenkins/secrets/initialAdminPassword
```
Bu buyruq `sudo cat /var/lib/jenkins/secrets/initialAdminPassword` parolni konsolda chop etadi. Terminaldan 32 belgidan iborat alphanumeric paroldan nusxa oling va uni Administrator paroli maydoniga joylashtiring, so'ng `Continue` tugmasini bosing. Keyingi ekranda tavsiya etilgan plaginlarni o'rnatish yoki maxsus plaginlarni tanlash imkoniyati mavjud:

![jenkins](/images/ci-cd/2.png)

Biz `suggested plugins` opsiyasini bosamiz, bu darhol o'rnatish jarayonini boshlaydi.

![jenkins](/images/ci-cd/3.png)

O'rnatish tugallangach, sizdan birinchi `Admin User` o'rnatish so'raladi. Bu bosqichni o'tkazib yuborish va yuqoridagi boshlang'ich parol yordamida administrator sifatida davom etish mumkin, lekin foydalanuvchi yaratishga biroz vaqt ajratamiz.

![jenkins](/images/ci-cd/4.png)

Siz Jenkins instance uchun afzal qilingan URL manzilini tasdiqlashingizni so'raydigan Instance Configuration sahifasini olasiz. Serveringiz uchun domen nomini yoki serveringizning IP manzilini tasdiqlang:

![jenkins](/images/ci-cd/5.png)

Tegishli ma'lumotlarni tasdiqlaganingizdan so'ng, `Save and Finish` tugmasini bosing. Siz `"Jenkins is Ready!"` degan tasdiqlash sahifasini olasiz:

![jenkins](/images/ci-cd/6.png)

Asosiy Jenkins boshqaruv paneliga tashrif buyurish uchun `Start using Jenkins` tugmasini bosing:

![jenkins](/images/ci-cd/8.png)

Shu nuqtada siz Jenkins-ni muvaffaqiyatli o'rnatdingiz. Keyingi qismga o'tamiz

**5. Nginx, certbot o'rnatish va domen ulab ssl sertifikat olish**

Serverimizga Jenkins o'rnatdik va uni dastlablki holat uchun zolab oldik lekin biz har doim jenkinsga kirganimizda serverimiz IP mazili va jenkins portini kiritib yozishimiz kerak bu yaxshimas lekin bunga kirish oson bo'lishi va xavfsiz bo'lishi uchun domen ulab ssl sertificat olamiz.

**6.Nginx va certbot o'rnatish uchun quyidagi buyruqdan foyalanasiz.**

```bash
sudo apt update
sudo apt install nginx
sudo apt install certbot python3-certbot-nginx
```
jenkinsga domen ulash uchun nginx configuratsiya qilishimiz kerak. `/etc/nginx/sites-available/` jildida domenimiz uchun configuratsiya fayl ochamiz. MAsalan domenimiz `jenkins.samidello.uz`.

```bash /jenkins.samidello.uz/
sudo nano /etc/nginx/sites-available/jenkins.samidello.uz
```
fayl nano matn muhrarrida ochilganidan keyin quyidagi Nginx configuratsiyani joylashtiring.

```bash filename="/etc/nginx/sites-available/jenkins.samidello.uz"
server {
    listen 80;
    server_name jenkins.samidello.uz;

    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```
**Nginx**dagi ushbu konfiguratsiya bloki `80`-portda `jenkins.samidello.uz` domeni orqali Jenkinsga kirish uchun `reverse proxy-`serverni o'rnatish uchun zarur. Ushbu Nginx configuratsiyani qismlarga bo'lib ko'rib chiqamiz.

```bash /server/ /listen/ /server_name/
server {
    listen 80;
    server_name jenkins.samidello.uz;
```
* `server` Bu blok Nginx-da server konfiguratsiya blokining boshlanishini bildiradi.

* `listen 80` Nginx standart **HTTP** porti bo'lgan **80**-portda tinglaydi(listen).

* `server_name jenkins.samidello.uz;` Ushbu server blokiga mos keladigan domen nomi yoki nomlarini belgilaydi. Bu holda, u `jenkins.samidello.uz` ga o'rnatiladi.

```bash /proxy_set_header/ /location/ /proxy_pass/
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
```
* `location /` Bu blok ushbu server bloki boshqaradigan joyni belgilaydi. Bunday holda, u ildiz(root) `/` ga o'rnatiladi, shuning uchun `jenkins.samidello.uz` saytiga har qanday so'rov ushbu blok tomonidan ko'rib chiqiladi.

* `proxy_pass http://localhost:8080;` Bu qator Jenkins ishlayotgan server backend serverini belgilaydi. Nginx `jenkins.samidello.uz` saytiga kelgan so'rovlarni Jenkins ishlashi kutilayotgan `http://localhost:8080` manziliga yo'naltiradi.

* `proxy_set_header` Bu qatorlar proksi-server so'rovi bilan birga uzatiladigan **header**halarni o'rnatadi. Ular asl client IP, host, protokol va boshqalar haqidagi ma'lumotlarni o'z ichiga oladi. Bu Jenkinsga Nginx orqali kelgan so'rovlarni to'g'ri bajarishga yordam beradi.

Ushbu konfiguratsiya **Nginx**-ni **Jenkins** uchun reverse proxy-server sifatida o'rnatadi. **80**-portda `jenkins.samidello.uz` manziliga Nginx tomonidan qabul qilingan har qanday so'rov(request) **8080**-portda lokal ravishda ishlaydigan Jenkins serveriga yo'naltiriladi. Shuningdek, so'rov Jenkinsga yetib kelganida mijoz ma'lumotlari yaxlitligini saqlash uchun zarur headerlar o'rnatilishini ta'minlaydi.

**7. SSL sertifikat olish va HTTP trafikni HTTPS ga yo'naltirish**

Nginx configuratsiya uchun symbolic link yaratish
```bash
sudo ln -s /etc/nginx/sites-available/jenkins.samidello.uz //etc/nginx/sites-enabled/jenkins.samidello.uz
```
Bu buyruq `/etc/nginx/sites-available` jildida Jenkins uchun yaratgan konfiguratsiya fayli (jenkins.samidello.uz) va `/etc/nginx/sites-enabled` jildi o'rtasida symbolic link hosil qiladi. Ushbu ulanishning maqsadi Nginx serveriga siz Jenkins uchun o'rnatgan konfiguratsiyani saytlar faollashtirilgan jildda mavjud qilish orqali o'qish va foydalanish imkonini berishdir.

**Nginx konfiguratsiya sintaksisini tekshirish**
```bash
sudo nginx -t
```
Ushbu buyruq hech qanday sintaksis xatosi yo'qligiga ishonch hosil qilish uchun Nginx konfiguratsiya fayllari sintaksisini tekshiradi. Bu Nginx-ning noto'g'ri konfiguratsiyalar tufayli ishga tushmasligining oldini olish uchun muhim qadamdir.

**SSL sertifikatini olish uchun Certbot-dan foydalanish.**

```bash
sudo certbot
```
Bu buyruq Certbot ilovasini ishga tushiradi. U bepul Sertifikat organi **Let's Encrypt**dan **SSL/TLS** sertifikatini olish uchun bir qator takliflar orqali foydalanuvchi bilan o'zaro aloqada bo'ladi. Certbot sizdan SSL sertifikatini olmoqchi bo'lgan Nginx server blokini tanlashni taklif qiladi. Bunday holda, u jenkins.samidello.uz saytini domen konfiguratsiyasi sifatida aniqlaydi va sertifikat berish jarayoni bo'yicha sizga yo'l ko'rsatadi. Ko'rsatmalar xizmat shartlariga rozi bo'lishni, yangilash bildirishnomalari uchun elektron pochta manzilini taqdim etishni va **HTTP** trafigini **HTTPS**ga yo'naltirishni tanlashni o'z ichiga oladi.

## Docker O'rnatish
