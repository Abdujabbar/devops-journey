import { Callout } from "nextra-theme-docs";

# ELK Stack o'rnatish va sozlash

![elk-setup](public/images/article/elk-setup/banner.png)

Oldingi [**ELK Stackga kirish**](https://devops-journey.uz/tutorials/article/elk-stack) mavzusida biz ELK nimaga ishlatilishi uning arxitekturasi va componentlari, qanday ishlashini ko'rib chiqgan edik. Bugungi amaliyotimizda biz ELK stack deploy qilishni ko'rib chiqamiz.
<Callout type="info" emoji="">
**Diqqat!** 
* Ushbu amaliyotni boshlash uchun [**ELK Stackga kirish**](https://devops-journey.uz/tutorials/article/elk-stack) qo'llanmasini o'qib chiqgan bo'lishingiz kerak bo'ladi.
* Ushbu amaliyotda biz **Elasticsearch** `7.17` versiyasidan foydalanamiz!
</Callout>

## Ishni boshlash

Ushbu amaliyotni amalga oshirish uchun bizga quyidagi minimum server talablaridagi server kerak bo'ladi.

<Callout type="info" emoji="">
**Minimum Server talabi**

| OS            | RAM            | CPU           | Xotira       |
| ------------- | -------------- | ------------- |------------- |
| Ubuntu 20.04  | 16GB           | 4vCPU,2 core  | 100GB        |

</Callout>

## Elasticsearch o'rnatish

Elasticsearcni Debian based serverlarga o'rnatish, Ubuntuga ham mos keladi.

**1->** Serverimizni yangilab kerakli dasturlarni o'rnatib olamiz.

```bash
sudo apt update && sudo apt upgrade -y
sudo apt-get install apt-transport-https
```

**2->** Elasticsearch PGP Keyini import qilib olamiz.

```bash
wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo gpg --dearmor -o /usr/share/keyrings/elasticsearch-keyring.gpg
```

**3->** `/etc/apt/sources.list.d`ga elasticsearchni qo'shib qo'yamiz.

```bash
echo "deb [signed-by=/usr/share/keyrings/elasticsearch-keyring.gpg] https://artifacts.elastic.co/packages/7.x/apt stable main" | sudo tee /etc/apt/sources.list.d/elastic-7.x.list
```

**4->** Elasticsearcni o'rnatib olamiz.

```bash
sudo apt-get update && sudo apt-get install elasticsearch
```

**5->** Elasticsearchni ishga tushiramiz.

daemonni reload qilamiz.

```bash
sudo systemctl daemon-reload
```

Elasticsearchni systemd yordamida avtomatik ishga tushishini yoqamiz.

```bash
sudo systemctl enable elasticsearch.service
```
Elasticsearchni ishga tushiramiz va statusini ko'ramiz.

```bash
sudo systemctl start elasticsearch.service
sudo systemctl status elasticsearch.service
```
![elk-setup](public/images/article/elk-setup/systemd.png)

Keling resurs ishlatilishini ko'ramiz.

```bash
htop
```
![elk-setup](public/images/article/elk-setup/htop.png)

hahaaa resurs RAM usage 8.53GB ))

**6->** Elasticsearch ishlayotganini bilish uchun `9200` portga HTTP request yuborib ko'ramiz.

```bash
curl -X GET "localhost:9200"
```

![elk-setup](public/images/article/elk-setup/curl.png)
Sizda yuqoridagidek natija chiqsa Elasticsearch ishlamoqda.

## Kibana o'rnatish

**1->** APT orqali **Kibana**ni o'rnatib olamiz.

```bash
sudo apt-get install kibana -y
```

**2->** Kibanani ishga tushiramiz.

daemonni reload qilamiz.

```bash
sudo systemctl daemon-reload
```
Kibanani systemd yordamida avtomatik ishga tushishini yoqamiz.

```bash
sudo systemctl enable kibana.service
```
Kibanani ishga tushiramiz va statusini ko'ramiz.

```bash
sudo systemctl start kibana.service
sudo systemctl status kibana.service
```
![elk-setup](public/images/article/elk-setup/systemd1.png)

**3->** Kibananin o'rnatib olganimizdan keyin tashqaridan brauzer orqali kirish uchun `/etc/kibana/kibana.yml` ni konfiguratsiya qilishimiz kerak.

![elk-setup](public/images/article/elk-setup/yml.png)

```bash {2,7}
# Kibana is served by a back end server. This setting specifies the port to use.
server.port: 5601

# Specifies the address to which the Kibana server will bind. IP addresses and host names are both valid values.
# The default is 'localhost', which usually means remote machines will not be able to connect.
# To allow connections from remote users, set this parameter to a non-loopback address.
server.host: "0.0.0.0"
```
Kibanaga restart beramiz.

```bash
sudo systemctl restart kibana.service
```

**4->** Kibana default `:5601` portda ishlaydi brauzerdan server IP adresi va `:5601` portga kirsak bizda Kibana dashboard ochilishi kerak.

![elk-setup](public/images/article/elk-setup/kibana.png)

Kibana dashboard statusini `:5601/status` pageda ko'rish mumkin.
![elk-setup](public/images/article/elk-setup/kibana-status.png)

## Logstash o'rnatish

**Beats** to'g'ridan-to'g'ri Elasticsearch ma'lumotlar bazasiga ma'lumotlarni yuborishi mumkin bo'lsa-da, ma'lumotlarni qayta ishlash uchun **Logstash**-dan foydalanish odatiy holdir. Bu sizga turli manbalardan ma'lumotlarni to'plash, ularni umumiy formatga aylantirish va boshqa ma'lumotlar bazasiga eksport qilish uchun ko'proq moslashuvchanlikni beradi.

**1->** APT orqali **Logstash**ni o'rnatib olamiz.

```bash
sudo apt-get install logstash -y
```
Logstashni o'rnatib bo'lganingizdan keyin sozlashga o'tishingiz mumkin. Logstash konfigursatsiya fayli `/etc/logstash/conf.d` joylashgan bo'ladi bu konfiguratsiya sintaksissi haqida [quyidagi havola](https://www.elastic.co/guide/en/logstash/current/configuration-file-structure.html) orqali ko'rib chiqishingiz mumkin.

Logstashni ma'lumotlarni bir tomondan qabul qiladigan, u yoki bu tarzda qayta ishlab belgilangan joyga jo'natadigan pipeline deb tassavur qilsangiz bo'ladi. Logstash asosiy elementlari ikkita `input` va `output` qo'shimcha `filter`. `input` plaginlari manbadan ma'lumotlarni oladi, `filter` plaginlarini uni qayta ishlaydi va `output` plaginlari esa ma'lumotlarni belgilangan joyga yuboradi.

![elk-setup](public/images/article/elk-setup/logstash.png)

**2->** `02-beats-input.conf` nomli Filebeat inputni o'rnatadigan konfiguratsiya faylini yaratib olamiz.

```bash
sudo nano /etc/logstash/conf.d/02-beats-input.conf
```
Quyidagi konfiguratsiyani kiriting. Bu konfiguratsiya input konfiguratsiya hisoblanadi va `beats` TCP `5044` portida kirishni bildiradi.
```bash filename="/etc/logstash/conf.d/02-beats-input.conf"
input {
  beats {
    port => 5044
  }
}
```