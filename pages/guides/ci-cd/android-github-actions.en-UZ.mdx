import { Callout } from "nextra-theme-docs";

# Github Actions bilan Anroid CI/CD

![android](/images/tutorials/ci-cd/android-cicd/banner.png)

Mobil applicationlarni ishlab chiqaradigan katta jamolarda ishlarni avtomatlashtirish uchun CI/CD pipelinelar ishlab chiqadilar. Bugun biz Android applicationlar uchun Github Actions bilan CI/CD yozamiz o'ylaymanki bu ko'pchilik mobil dasturchilar uchun qiziqarli va foydali bo'ladi. Bugun CI/CD biz Android applarda har xil testlar qilasiz kodni analiz qilamiz Android release qilamiz va oxirida Google Play Storega deploy qilamiz. Notificationlar uchun Githubni Discord bilan inetegratsiya qilamiz. ushbu qo'llanmda biz kod analiz uchun **Sonarqube**, Test uchun esa **JUnit** ishlatamiz.


## Discord bilan integratsiya

Biz loyihamizni discord bilan integratsiya qilish uchun `Discord webhook` dan foydalanamiz. Discord bilan integratsiya qilishda Discord server ochib olishimiz va serverda channel ochishimiz kerak. 

<Callout type="info" emoji="">
Discord channel ochish va Discord webhook olib Githubdagi loyiha bilan integratsiya qilish bo'yicha quyidagi [video qo'llanmani](https://youtu.be/-KDQqWNK3Tw?si=L8YYPAX4RKVi1ACa) ko'rib chiqishingiz mumkin.
</Callout>

## Github Actions CI

Har doimgidek CI/CD yozishni birinchi bo'lib CI yozishdan boshlaymiz. Birinchi navbatda loyihamiz root papkasida **.github** papka ochib ichida yana **workflows** papka ochib unda **android-ci.yml** ochib olamiz.

Keling birinchi oddiy **Android CI** yozamiz uni vazifasi kerakli dasturlarni o'rnatik APK build qiladi.

```bash
name: Build and Release APK

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: '17'
          distribution: 'adopt'

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew
        
      - name: Build APK
        run: ./gradlew assembleRelease
```
Keling ushbu oddiy **Andorid CI** konfiguratsiyani yozib **main** branchga push qilamiz. Repositoriyamizga **android-ci.yml** konfiguratsiyamizni **main** branchga push qilganimizdan keyin repositoriyamiz **Actions** bo'limiga o'tib jarayonni kuzatishimiz mumkin.

![android](/images/tutorials/ci-cd/android-cicd/actions1.png)

Okey bizda jarayon muvaffaqiyatli yakunlandi.
![android](/images/tutorials/ci-cd/android-cicd/actions2.png)

Endi keling ushbu kichik **Andorid CI** tuzulishini qanday ishlashini ko'rib chiqamiz, undan keyin keyingi bosqichlarga o'tsak bo'ladi.

```bash
name: Build and Release APK

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
```

Ushbu qismda birinchi qator Action nomini belgilaydi bu holda bizda **Build and Release APK** bo'ladi. Keyingi  Belgilangan qism esa **Trigger** deb nomlanadi, ya'ni loyihamiz repositoriyasi **main** branchga commit bo'lib o'zgarish bo'lganida va yoki pull request kelib tushganda avtomatik Github Actions ishga tushishini bildiradi.


```bash
jobs:
  build_and_release:
    runs-on: ubuntu-latest
```
Bu qismda **build_and_release** nomli bitta **job** ochiladi va u **ubuntu-latest** runnerda ishga tushishini bildiradi.

```bash
- name: Checkout Repository
  uses: actions/checkout@v4
```
Bu qism [actions/checkout@v4](https://github.com/actions/checkout) orqali loyiha kodlarni runnerda klon qilib oladi.

```bash
- name: Setup JDK 17
  uses: actions/setup-java@v2
  with:
    java-version: '17'
    distribution: 'adopt'
```

Ushbu qismda **ubuntu-latest** runnerga [actions/setup-java@v2](https://github.com/actions/setup-java) orqali Java **JDK 17 adopt** distributioni o'rnatadi.

```bash
- name: Grant execute permission for gradlew
  run: chmod +x ./gradlew
```
Gradle orqali APK buil qilishimiz uchun **gradlew** executeb qilish permissionni beramiz.

```bash
- name: Build APK
  run: ./gradlew assembleRelease
```
Gradle yordamida APK buil qilamiz.

Yuqorida biz oddiy, sodda Android CI yozdik keling endi Andorid CI'ni kengaytiramiz.

```bash
name: Android CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  cache-gradle:
    name: Cache Gradle dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the code
        uses: actions/checkout@v4

      - name: Cache Gradle
        uses: actions/cache@v2
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle') }}
          restore-keys: ${{ runner.os }}-gradle-
```
**android-ci.yml** konfiguratsiyamizni quyidagi yangilaymiz. ushbu yangilashda biz keyingi CI'lar tezroq ishlashi uchun [actions/cache@v2](https://github.com/actions/cache) yordamida Gradle keshlashni sozladik. Ushbu CI qismda biz matrix usuldan foydalanamiz va bir nechta boshqichlar qo'shamiz bular quyidagilar:


* **-> Cache Gradle dependencies**
* **-> Perform lint check**
* **-> Perform Unit Testing**
* **-> Perform Instrumentation Testing**
* **-> Perform static code analysis**
* **-> Generate Debug APK**

### Perform lint check

**-> Cache Gradle dependencies** bosqichidan keyin undan keyingi bosqichlar parallel ishga tusha boshlaydi.

```bash
  lint:
    name: Perform lint check
    needs: [cache-gradle]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the code
        uses: actions/checkout@v4

      - name: Set up Java JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: '17'
          distribution: 'adopt'

      - name: Make Gradle executable
        run: chmod +x ./gradlew

      - name: Run lint
        run: ./gradlew lintDebug

      - name: Upload html test report
        uses: actions/upload-artifact@v2
        with:
          name: lint.html
          path: app/build/reports/lint-results-debug.html
```