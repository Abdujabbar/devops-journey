---
image: https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/banner.png
description: "Java Spring Boot Deployment: Gitlab CI va Github Actions"
---

import { Callout } from "nextra-theme-docs";
import { Tabs, TabList, Tab, TabPanel } from 'react-tabs';
import 'react-tabs/style/react-tabs.css';

# Sonatype Nexus Repository Manager

![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/banner.png)

## Kirish

Bugungi software development jarayonlarida CI/CD (Continuous Integration/Continuous Deployment) jarayonlarini samarali yuritish muhim ahamiyat kasb etadi. Bunday jarayonlarda paketlar va artifaktlarni boshqarish uchun maxsus repository managerlar kerak bo'ladi. **Sonatype Nexus Repository Manager** - eng ommabop va ishonchli artifakt menejerlardan biri bo'lib, Java (Maven, Gradle), .NET (NuGet), Python (PyPi), Docker va boshqa paketlarni saqlash va boshqarish uchun eng mashhur va ishonchli yechimlardan biridir.

Nexus opensource **(Nexus OSS)** va pullik **(Nexus Pro)** versiyalarda mavjud bo'lib, ushbu qo'llanma asosan **Nexus OSS** bilan ishlashga yo'naltirilgan.

**Sonatype Nexus Repository Manager** dasturi dastlab 2007-yilda **Sonatype Inc**. tomonidan ishlab chiqilgan. U dasturiy ta'minot artifaktlarini saqlash, boshqarish va tarqatish uchun mo'ljallangan markazlashtirilgan repository menejeri sifatida ishlab chiqilgan.

Nexus Repository Manager dasturiy ta'minot ishlab chiqishda artifaktlar va paketlarni saqlash, boshqarish hamda ularga kirishni ta'minlash uchun ishlatiladi. Java (Maven, Gradle), .NET (NuGet), Node.js (NPM), Docker, Python (PyPi) kabi texnologiyalar uchun artifaktlarni markazlashtirilgan holda saqlaydi va boshqaradi.Tashqi repository'lardan yuklash jarayonlarini tezlashtirish va tarmoq yuklamasini kamaytirish imkonini beradi va Korxona ichki(local) repository'sini yaratishi, Kompaniyaning o'ziga xos kutubxonalarini(library) boshqarish, xavfsizlikni ta'minlash va dasturiy ta'minot jarayonlarini optimallashtirish uchun ishlatiladi.


Bu amaliyotda biz **Sonatype Nexus Repository Manager**ni docker yordamida o'rnatish va sozlashni va loyihalarimizga va CI/CD ga integratsiya qilishni ko'rib chiqamiz.


## Nexus o'rnatish

Bu amaliyotda biz **Nexus**ni docker yordamida ishga tushiramiz va o'rnatishning manual va ansible yordamida qilishni ko'rib chiqamiz.
<Callout type="info" emoji="">
**Minimum Server talabi**

| OS            | RAM            | CPU           | Xotira       | Static IP  |
| ------------- | -------------- | ------------- |------------- | ---------- |
| Ubuntu 20.04 yoki Rocky Linux 8 | 8GB          | 4  | 80GB         | Ha kerak   |
</Callout>
Quyidagi qo'llanmadan foydalanib Docker o'rnatib olishingiz mumkin - [**Docker o'rnatish**](https://devops-journey.uz/guides/konteyner/docker-ornatish)


<Tabs>
<TabList>
<Tab>Manual</Tab>
<Tab>Ansible</Tab>
</TabList>
<TabPanel>
### Manual o'rnatish
**1->** Nexusni docker orqali o'rnatayotganimiz sababli nexus malumotlarini docker volume yoki hostpath qilib saqlashimiz kerak bo'ladi aks holda nexus container restart bo'lganda malumotlar o'chib ketadi shuning uchun nexusga data papka ochib olamiz.
```bash
sudo mkdir -p /mnt/nexus/nexus-data
sudo chown -R 200 /mnt/nexus/nexus-data
```
**2->** Nexusni docker yordamida ishga tushiramiz va `nexus-data`ni serverimizdagi `/mnt/nexus/nexus-data`ga ulab qo'yamiz va `--restart=always` flagi orqali tasodifan server yoki docker  restart bo'lganda avtomatik ishga tushirilishini belgilaymiz.

```bash
docker run -d -p 8081:8081 --name nexus --restart=always -v /mnt/nexus/nexus-data:/nexus-data sonatype/nexus3
```
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/1.png)

**3->** Nexusni ishga tuhsirganimizdan keyin u default admin user va parol bilan birga keladi, admin parolni olish uchun quyidagicha amalni bajaramiz.

```bash
docker exec -it nexus cat /nexus-data/admin.password
```
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/2.png)
</TabPanel>
<TabPanel>
### Ansible bilan o'rnatish

**1->** **[github.com/ismoilovdevml/infra-as-code]**(https://github.com/ismoilovdevml/infra-as-code) repositoriyani git clone qilib olamiz bu repositoriyada ko'plab ansible playbooklar bor shu jumladan nexus uchun ham.

```bash
git clone https://github.com/ismoilovdevml/infra-as-code.git
```
**2->** Nexus playbokga o'tamiz.

```bash
cd infra-as-code/Ansible/nexus
```

```bash
├── ansible.cfg
├── cleanup_nexus_docker.yml
├── install_nexus.yml
├── invnetory.ini
└── vars.yml
```

`vars.yml` faylida variablelar berilgan bo'ladi, bunda nexus image, nexus data papkasi, nexus container nomi, nexus porti, nexus admin parol fayli va nexus parent papkasi berilgan.

```yaml filename="vars.yml"
---
nexus_image: "sonatype/nexus3:latest"
nexus_data_dir: "/mnt/nexus/nexus-data"
nexus_container_name: "nexus"
nexus_port: 8081
nexus_admin_password_file: "/nexus-data/admin.password"
nexus_parent_dir: "/mnt/nexus"
```

**4->** `inventory.ini` faylida serverlarimizni yozamiz, bu holda serverlarga ssh key bilan ulanadi.

```ini filename="inventory.ini"
[nexus_servers]
nexus-server ansible_host=159.89.94.148 ansible_user=root
```
Agar siz parol bilan ulanmoqchi bo'lsangiz quyidagicha yozishingiz mumkin.

```ini filename="inventory.ini"
[nexus_servers]
nexus-server ansible_host=159.89.94.148 ansible_user=root ansible_password=your_password
```

**5->** Asosiy ikkita playbook bor, bular `install_nexus.yml` va `cleanup_nexus_docker.yml` bu playbooklar orqali nexusni o'rnatish va o'chirishni bajaramiz. Playbookni ishga tushirishdan oldin kerakli ansible collectionlarni o'rnatishimiz kerak yani `community.docker` va `community.general` collectionlarini o'rnatishimiz kerak.

```bash
ansible-galaxy collection install community.general -f
ansible-galaxy collection install community.docker -f
```

**6->** Nexusni o'rnatish uchun quyidagicha playbookni ishga tushiramiz.

```bash
ansible-playbook -i inventory.ini install_nexus.yml
```
Playbook muvaffaqiyatli ishga tushirilgandan keyin default `admin` user parolini ko'rsatadi.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/11.png)

</TabPanel>
</Tabs>

Nexusni o'rnatib bo'lganimizdan keyin brauzerda `server_ip:8081` manzilini ochganimizda Nexus ochilishi kerak.

![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/3.png)

Bu qismda **->Sign in** bosib Nexusning login sahifasiga o'tamiz.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/4.png)
Default `admin` user va generatsiya qilingan default parol bilan kiramiz.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/5.png)
Bu qismda esa default parol o'rniga o'zimiz yangi parol qo'yishni talab qiladi yangi parolni yozib kiritamiz.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/6.png)
Bu qismda o'zimizga kerak tanlovni tanlaymiz.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/7.png)
Sizda `admin` user bilan kirganingizdan keyin sizda quyidagicha dastlabki sahifa ochiladi.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/8.png)

## Nexus bilan tanishuv

Nexus Repository Manager **APT, Cargo, Bower CocoaPods, Composer, Conan, Conda, Docker, Git LFS, Go, Helm, Hugging Face, Maven, npm, NuGet, p2, PyPI, R, Raw, RubyGems, Yum(RPM)** kabi texnologiyalar uchun repositorylar yaratish va boshqarishni qo'llab-quvvatlaydi.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/37.png)

**Sonatype Inc**ning **Sonatype Nexus Repository**dan tashqari **Sonatype Repository Firewall**, **Sonatype Lifecycle** va **Sonatype SBOM** kabi service'lari  ham mavjud.

![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/38.png)
Nexusga kirganimizda asosiy sahifa ochiladi.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/8.png)
**-> Server Administration and Configuration** bo'limida server va konfiguratsiyalarini o'zgartirish imkoniyati mavjud.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/15.png)
**-> Blob Stores** bo'limida Nexusning fayllarni saqlash uchun ishlatiladigan papkalarni ko'rishimiz mumkin, bizning holda `default` papkasi(blobstore) mavjud.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/16.png)
**-> Repository** bo'limida repositorylarimizni ko'rishimiz mumkin, nexusda default **maven-public, maven-central, maven-releases, maven-snapshots, nuget-group, nuget-hosted, nuget.org-proxy** repositorylar mavjud.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/17.png)

Agar siz kompaniyangizda **Proxy** bilan internetga chiqish talab qilinsa **-> Settings -> System -> HTTP** bo'limiga o'tib proxy sozlashimiz mumkin.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/18.png)
**HTTP Proxy** uchun `Enable HTTP Proxy`ni belgilaymiz va `HTTP Proxy Host` ga proxy serverimiz addresi va `HTTP Proxy Port` ga portni kiritamiz.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/19.png)
**HTTPS Proxy** uchun `Enable HTTPS Proxy`ni belgilaymiz va `HTTPS Proxy Host`ga proxy serverimiz addresi va `HTTPS Proxy Port` ga portni kiritamiz. Agar sizning proxyyingiz **HTTPS Authentication**ni talab qilinsa `Enable HTTPS Proxy Authentication`ni belgilaymiz va `HTTPS Proxy Username` va `HTTPS Proxy Password`ni kiritib ishlatishimiz mumkin.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/20.png)
Nexus servergfa proxy sozlamalarini sozlagandan keyin proxysiz ulanaidgan local sercvicelarimizga **NO Proxy Hosts** qismida yozishimiz mumkin.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/21.png)

## Repositorylar bilan ishlash

**Sonatype Nexus Repository Manager** repositoriyalarni tashkil qilish va boshqarish uchun turli xil turlarni(repo type) qo'llab-quvvatlaydi, ulardan eng asosiylari **Proxy, Hosted va Group** repository'laridir.

**Proxy** typedagi repository - tashqi (remote) repository'larni mahalliy (local) server orqali kechlashtirish (cache) va ulardan foydalanishni optimallashtirish uchun ishlatiladi. U **Maven Central, NuGet Gallery, Docker Hub, NPM Registry, PyPi** va boshqa repository'lardan paketlarni olish uchun qo'llaniladi. Bu turdagi repositoriyaning asosiy maqsadi internetga chiqishni kamaytirish va local serverda paketlarni saqlashdir, loyihamiz nexusga ulanganidna keyin u paketlarni yuklab olish uchun birinci bo'lib nexusga so'rov yuboradi agar loyiha so'ragan package nexus local repositoriyada bo'lmasa **Proxy** typedagi repositoriya berilgan **remote repository**dan oladi va nexus local repositoriyada cache qilib saqlaydi.

**Hosted** typedagi repository - lokal serverda paketlarni saqlash uchun ishlatiladi. U **Maven, NuGet, Docker, PyPi** va boshqa paketlarni saqlash uchun ishlatiladi. Bu turdagi repositorylar loyihalarga xizmat qilish uchun ishlatiladi, loyiha paketlarini yuklash uchun ishlatiladi.  Bu turdagi repositoriyaning asosiy maqsadi Kompaniya uchun maxsus yozilgan packagelar uchun local repository bo'lib xizmat qiladi.

**Group** repository - bu bir nechta repository'larni bitta umumiy repositoriya sifatida boshqarish imkonini beruvchi repository turi. Group repository bir vaqtning o'zida **Proxy, Hosted** va boshqa repositoriyalarni bitta URL orqali boshqarishga yordam beradi. Bu turdagi repositoriya ishlatishga bitta misol: maslan sizda **maven-central, maven-releases, maven-snapshots** repositorylar mavjud bo'lsa siz ularni bitta **maven-public** repositoryda birlashtirib qo'yishingiz mumkin va loyihalarga bitta URL orqali boshqarish imkonini beradi, yani siz loyihangizni Nexusga ulaganingizda bitta **maven-public** repositoriyani belgila ishlatishingiz mumkin uching ichida esa **maven-central, maven-releases, maven-snapshots** repositorylar mavjud bo'ladi.


Nexusda default holda **Maven va Nuget** uchun **Proxy, Hosted** va **Group** repositorylar mavjud bo'ladi, **Python, Go, Docker, Cargo** va boshqalar uchun o'zingiz repositorylar yaratishingiz kerak bo'ladi.

**Proxy** repositoriyalar vazifasi 

**-> Server Administration and Configuration** bo'limidan **-> Repositories** bo'limiga o'tib repositorieslarni ko'rishimiz mumkin.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/15.png)
Nexus default repositoriyalar.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/17.png)
Keling masalan **maven-central** repositoryni ko'rib chiqamiz. Bu repository turi **Proxy** bo'lib internetdan **https://repo1.maven.org/maven2/** manzilidan ma'lumotlarni olish uchun ishlatiladi.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/22.png)
Quyidagi rasmda maven packagelarni qaysi global repositorydan olishini ko'rishimiz mumkin **https://repo1.maven.org/maven2/**.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/23.png)

![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/24.png)

**maven-public** repository **group** repository bo'lib **maven-central, maven-releases, maven-snapshots** repositorylarini birlashtirgan repository bo'lib, bu repositorydan maven packagelarni olishimiz mumkin.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/25.png)
Bu rasmda **maven-public** repositoriyamiz o'z ichiga olgan **maven-central, maven-releases, maven-snapshots** repositorylarini ko'rishimiz mumkin.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/26.png)
**nuget-group** repository ham **group** repository bo'lib **nuget-hosted, nuget.org-proxy** repositorylarini birlashtirgan repository bo'lib, bu repositorydan nuget packagelarni yani .NET packagelarni olishimiz mumkin.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/27.png)
**nuget.org-proxy** repository **proxy** repository bo'lib **https://api.nuget.org/v3/index.json** addresidan nuget packagelarni olish uchun ishlatiladi.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/28.png)


## Loyihalarga Nexusni integratsiya

Bu bosqichda **Maven va NuGet** loyihalarini **Sonatype Nexus Repository Manager** bilan integratsiya qilish va shuningdek, CI/CDga qo'shishni ko'rib chiqamiz. Bu bilan biz Nexus'ni ishlatish orqali **build** vaqtlarini qisqartirish, paketlarni local boshqarish va xavfsizlikni oshirish imkoniyatiga ega bo'lamiz.

### Java Maven
Platformamizda **[Java Spring Boot Deployment: Gitlab CI va Github Actions](https://devops-journey.uz/guides/ci-cd/java-spring-boot-deployment)** amaliyotida biz Spring Boot Maven projectni GItlab CI va Github Actyions bilan CI/Cd yozib ishga tushirishni ko'rib chiqgandik endi bu bosqichda unga nexus inetgratsiyani ko'rib chiqamiz.

**1->** Loyihangizda `pom.xml` faylga quyidagicha dependencyni qo'shib qo'yamiz.

```xml /nexus.helm.uz/ filename="pom.xml"
<repositories>
    <repository>
        <id>nexus</id>
        <url>https://nexus.helm.uz/repository/maven-public/</url>
        <releases>
            <enabled>true</enabled>
        </releases>
        <snapshots>
            <enabled>true</enabled>
        </snapshots>
    </repository>
</repositories>

<pluginRepositories>
    <pluginRepository>
        <id>nexus</id>
        <url>https://nexus.helm.uz/repository/maven-public/</url>
        <releases>
            <enabled>true</enabled>
        </releases>
        <snapshots>
            <enabled>true</enabled>
        </snapshots>
    </pluginRepository>
</pluginRepositories>
```
`<repositories>` bo'limi Mavenga Nexus'dagi dependencylarni yuklab olish uchun qayerga murojaat qilish kerakligini bildiradi. `<id>` - Repository'ni identifikatsiya qilish uchun unikal nom (nexus deb belgilangan) `<url>` - Nexus repositoryning manzili (https://nexus.helm.uz/repository/maven-public/). `<releases>` - Release versiyalarning yuklab olinishi yoqilgan (true). `<snapshots>` - Snapshot versiyalar ham qollab-quvvatlanishi yoqilgan (true).

`<pluginRepositories>` Maven plugin'larini Nexus repositorydan yuklash uchun ishlatiladi. Bu Maven build va test jarayonlari uchun zarur bo'lgan plaginlarni Nexus orqali yuklashni taminlaydi.Agar loyiha Maven pluginlari uchun Nexus'dan foydalanmoqchi bo'lsa, ushbu bo'lim kiritilishi shart.

**2->** Loyihangizda `settings.xml` faylga quyidagicha sozlamalarni qo'shib qo'yamiz.

```xml /nexus.helm.uz/ filename="settings.xml" {5-11, 13-20, 22-38, 40-42}
<settings xmlns="http://maven.apache.org/SETTINGS/1.2.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.2.0 https://maven.apache.org/xsd/settings-1.2.0.xsd">
    
    <servers>
        <server>
            <id>nexus</id>
            <username>${env.NEXUS_USER}</username>
            <password>${env.NEXUS_PASSWORD}</password>
        </server>
    </servers>

    <mirrors>
        <mirror>
            <id>nexus</id>
            <mirrorOf>*</mirrorOf>
            <url>https://nexus.helm.uz/repository/maven-public/</url>
            <layout>default</layout>
        </mirror>
    </mirrors>

    <profiles>
        <profile>
            <id>nexus</id>
            <repositories>
                <repository>
                    <id>nexus</id>
                    <url>https://nexus.helm.uz/repository/maven-public/</url>
                    <releases>
                        <enabled>true</enabled>
                    </releases>
                    <snapshots>
                        <enabled>true</enabled>
                    </snapshots>
                </repository>
            </repositories>
        </profile>
    </profiles>

    <activeProfiles>
        <activeProfile>nexus</activeProfile>
    </activeProfiles>
</settings>
```
`<servers>` bo'limi Autentifikatsiya konfiglarini o'z ichiga oladi. `<id>` - `pom.xml`dagi repository ID bilan bir xil bo'lishi kerak (nexus). `<username>` va `<password>` - Nexus'ga kirish uchun foydalanuvchi nomi va parol. Nexusga kirish uchun login va parol environment avribale sifatida yozilgan `${env.NEXUS_USER}` va `${env.NEXUS_PASSWORD}`.
Bu konfiguratsiya Nexusga artifaktlarni yuklash (`mvn deploy`) yoki yuklab olish (`mvn install`) uchun autentifikatsiyani ta'minlaydi.

`<mirrorOf>*</mirrorOf>` - Barcha (*) repository'lar uchun Nexus'ni o'zgartirilgan mirror sifatida ishlatishni bildiradi. `<url>` - Nexus'ning **maven-public** repositoriyasi orqali barcha dependencylarni yuklash bildiradi. `<layout>` esa default Maven repository arxitekturasi ishlatiladi.

Bu bo'lim **Maven Central** yoki boshqa tashqi repositoriyalarni bevosita ishlatish o'rniga, ularni Nexus orqali yuklab olishni ta'minlaydi.

`<profiles>` bo'limi turli xil konfiguratsiyalarni yaratish va ishlatish imkonini beradi, bunda biz `<id>` nexus nomli profil yaratib olamiz va  `<repositories>` bu Maven repositorylarini yaratish uchun ishlatiladi, unga biz Nexus repositoriya urlni qo'shib qo'yamiz va `<activeProfiles>` bo'limida nexusni profilni faollashtiramiz, shunda mvn buyruqlari bajarilganda, Maven ushbu profilni ishlatadi, nexus profili faollashtirilganda, Maven dependencylarni https://nexus.helm.uz/repository/maven-public/ orqali yuklaydi.

**3->** `${env.NEXUS_USER}` va `${env.NEXUS_PASSWORD}` environment variablelarni agar sizda Gitlab bo'lsa Gitlab variablesga yoki Githubda bo'lsa Github Secretsga qo'shib qo'yishimiz kerak bo'ladi.

Gitlabda **Settings -> CI/CD -> Variables** bo'limiga o'tib quyidagicha variablelarni qo'shib qo'yamiz.

`NEXUS_USER` - Nexusga kirish uchun foydalanuvchi nomi.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/32.png)
`NEXUS_PASSWORD` - Nexusga kirish uchun foydalanuvchi paroli.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/33.png)

Githubda esa **Settings -> Secrets -> New repository secret** bo'limiga o'tib quyidagicha secretlarni qo'shib qo'yamiz.

`NEXUS_USER` - Nexusga kirish uchun foydalanuvchi nomi.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/34.png)
`NEXUS_PASSWORD` - Nexusga kirish uchun foydalanuvchi paroli.
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/35.png)

**4->** Maven loyihani `settings.xml` bilan ishga tushirish uchun Dockerfileni ham yangilashimiz kerak bo'ladi.
```bash
COPY settings.xml /root/.m2/settings.xml
```
qatorini Dockerfilega qo'shib qo'yamiz.
    
```bash filename="Dockerfile" {3}
FROM maven:3.9.5-eclipse-temurin-17-alpine AS builder
WORKDIR /app
COPY settings.xml /root/.m2/settings.xml
COPY pom.xml .
RUN mvn dependency:go-offline -B
COPY src ./src
RUN mvn package -DskipTests -B

FROM eclipse-temurin:17-alpine
RUN addgroup -S appgroup && adduser -S appuser -G appgroup
WORKDIR /app
COPY --from=builder /app/target/*.jar app.jar
RUN chown -R appuser:appgroup /app
USER appuser
EXPOSE 8080
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD wget --spider --quiet http://localhost:8080/actuator/health || exit 1
ENTRYPOINT ["java", "-jar", "app.jar"]
```

**5->** Loyihamiz CI/CD'dasida ham o'zgarishlar kiritishimiz kerak bo'ladi.

Gitlab CI uchun `before_script` bo'limiga quyidagicha  yangilamymiz bu qatorlar `sed` yordamida `settings.xml` faylga `NEXUS_USER` va `NEXUS_PASSWORD` environment variablelarni yozadi.

```yaml filename=".gitlab-ci.yml"
  before_script:
  - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  - sed -i "s|\${env.NEXUS_USER}|${NEXUS_USER}|g" settings.xml
  - sed -i "s|\${env.NEXUS_PASSWORD}|${NEXUS_PASSWORD}|g" settings.xml
```
To'liq Gitlab CI `.gitlab-ci.yml` fayli quyidagicha ko'rinishda bo'ladi.

```yaml filename=".gitlab-ci.yml" {26-29}
stages:
  - build_and_push
  - deploy

variables:
  IMAGE_NAME: waifulist
  CONTAINER_NAME: waifulist
  PORT: "8080:8080"
  REPO_NAME: $CI_PROJECT_PATH
  REGISTRY: "registry.gitlab.com"
  SSH_HOST: $SERVER_IP
  SSH_USER: $SERVER_USERNAME
  SSH_KEY: $SSH_PRIVATE_KEY
  SPRING_PROFILES_ACTIVE: dev
  DEV_DATABASE_URL: $DEV_DATABASE_URL
  DEV_DATABASE_USERNAME: $DEV_DATABASE_USERNAME
  DEV_DATABASE_PASSWORD: $DEV_DATABASE_PASSWORD

build_and_push:
  stage: build_and_push
  image: docker:stable

  services:
    - docker:dind

  before_script:
  - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  - sed -i "s|\${env.NEXUS_USER}|${NEXUS_USER}|g" settings.xml
  - sed -i "s|\${env.NEXUS_PASSWORD}|${NEXUS_PASSWORD}|g" settings.xml

  script:
    - docker build -t "$REGISTRY/$REPO_NAME/$IMAGE_NAME:$CI_COMMIT_SHA" .
    - docker push "$REGISTRY/$REPO_NAME/$IMAGE_NAME:$CI_COMMIT_SHA"

deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --update --no-cache openssh-client

  script:
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts 
    - ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "echo "$CI_JOB_TOKEN" | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY"
    - ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "docker pull $REGISTRY/$REPO_NAME/$IMAGE_NAME:$CI_COMMIT_SHA"
    - ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "docker stop $CONTAINER_NAME || true"
    - ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "docker rm $CONTAINER_NAME || true"
    - ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "docker run -d --name $CONTAINER_NAME --restart=always -p $PORT -e SPRING_PROFILES_ACTIVE=$SPRING_PROFILES_ACTIVE -e DEV_DATABASE_URL=$DEV_DATABASE_URL -e DEV_DATABASE_USERNAME=$DEV_DATABASE_USERNAME -e DEV_DATABASE_PASSWORD=$DEV_DATABASE_PASSWORD $REGISTRY/$REPO_NAME/$IMAGE_NAME:$CI_COMMIT_SHA"
```
Github Actions uchun.

```yaml filename=".github/workflows/main.yml"
- name: Replace Nexus Credentials in settings.xml
  run: |
    sed -i "s|\${env.NEXUS_USER}|${{ secrets.NEXUS_USER }}|g" settings.xml
    sed -i "s|\${env.NEXUS_PASSWORD}|${{ secrets.NEXUS_PASSWORD }}|g" settings.xml
```
To'liq Github Actions `ci-cd` fayli quyidagicha ko'rinishda bo'ladi.

```yaml filename=".github/workflows/main.yml" {32-35}
name: Github Actions CI/CD
 
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
 
env:
  REPO_NAME: ${{ github.repository }}
  CONTAINER_NAME: waifulist
  REGISTRY: ghcr.io
  SSH_HOST: ${{ secrets.SERVER_IP }}
  SSH_USER: ${{ secrets.SERVER_USERNAME }}
  SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  PORT: 8080:8080
  SPRING_PROFILES_ACTIVE: dev
 
jobs:
  build_and_push:
    runs-on: ubuntu-latest
    permissions:
        contents: read
        packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
 
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Replace Nexus Credentials in settings.xml
        run: |
          sed -i "s|\${env.NEXUS_USER}|${{ secrets.NEXUS_USER }}|g" settings.xml
          sed -i "s|\${env.NEXUS_PASSWORD}|${{ secrets.NEXUS_PASSWORD }}|g" settings.xml

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
 
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: "${{ env.REGISTRY }}/${{ env.REPO_NAME }}:${{ github.sha }}"
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.REPO_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.REPO_NAME }}:buildcache,mode=max

  deploy:
    needs: build_and_push
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Executing remote SSH commands to deploy
        uses: appleboy/ssh-action@master
        with:
          host: "${{ env.SSH_HOST }}"
          username: "${{ env.SSH_USER }}"
          key: "${{ env.SSH_KEY }}"
          script: |
            echo ${{ secrets.GITHUB_TOKEN }} | docker login -u ${{ github.actor }} --password-stdin ${{ env.REGISTRY }}
            docker pull "${{ env.REGISTRY }}/${{ env.REPO_NAME }}:${{ github.sha }}"
            docker stop "${{ env.CONTAINER_NAME }}" || true
            docker rm "${{ env.CONTAINER_NAME }}" || true
            docker run -d --name ${{ env.CONTAINER_NAME }} --restart=always -p ${{ env.PORT }} \
            -e SPRING_PROFILES_ACTIVE=${{ env.SPRING_PROFILES_ACTIVE }} \
            -e DEV_DATABASE_URL=${{ secrets.DEV_DATABASE_URL }} \
            -e DEV_DATABASE_USERNAME=${{ secrets.DEV_DATABASE_USERNAME }} \
            -e DEV_DATABASE_PASSWORD=${{ secrets.DEV_DATABASE_PASSWORD }} \
            ${{ env.REGISTRY }}/${{ env.REPO_NAME }}:${{ github.sha }}
```

**6->** keling endi loyiha CI/CD'da ishga tushirib uni tekshirib ko'ramiz, loyihamiz barcha package va dependencylarni Nexus orqali yuklab olishi kerak.

Gitlab CI'da ko'rib turganinigizdek barcha package va dependencylarni **nexus.helm.uz/repository/maven-public/** manzili orqali yuklab olyapti. 
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/31.png)
Github Actionsda
![nexus](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/nexus/36.png)

