---
image: https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/gitlab-ci/banner.png
description: "Gitlab CI bilan CI/CD"
---

import { Callout } from "nextra-theme-docs";

# Gitlab CI bilan CI/CD

![gitlab-ci](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/gitlab-ci/banner.png)


## Kirish
**GitLab** - bu veb-ga asoslangan Git repository manageri va DevOps platformasi bo'lib, u dastruchilar o'rtasidagi hamkorlikni soddalashtiradi. U **GitLab CI** orqali versiyani boshqarish(version control), code review, issue tracking va **CI/CD**ni avtomatlashtirish kabi xususiyatlarni taklif etadi. GitLab CI bilan ishlab dasturchilar applicationlarni build qilish, testdan o'tkazish va deploymentni avtomatlashtirish uchun pipelinelarni belgilaydilar. Ushbu integratsiya jamoalarga yuqori sifatli dasturiy ta'minotni samarali va ishonchli yetkazib berish imkonini beradi.

Qisqa qilib aytganda Gitlab web-based git repository manager buni Githubga o'xshatish mumkin, Githubda hamma ishlagan bo'lishi kerak menimcha. Github asosan Open Source loyihlar uchundir private organizatsiylarda ham ishlash mumkin lekin Gitlabdek qulayliklar bo'lmaydi. Githubni o'z serverlaringizda o'rnatib,sozlab ishlata olmaysiz bu ba'zi bir tashkilotlar qonun-qoidalariga to'gri kelmaydi, ko'p tashkilotlar o'z loyiha kodlarini o'z serverlarida saqlashni xohlashdi bunda bizga Gitlab keladi. Siz Gitlabni o'zingizni serverlaringizda o'rnatib o'z Gitlab serveringizni sozlab be'malol ishlashingiz mumkin.

**Gitlab CI** bu Gitlabda loyihlarniga **CI/CD** pipelinelar yozish loyihlarni avtomatlashtirish bir nechta qulayliklarni beruvchi **CI/CD** tool hisoblanadi, **Gitlab CI**ni **Github Actions**ga o'xshatish mumkin.

Bugungi amaliyotimizda biz docker containerlar bilan ishlaydigan birinchi sodda **CI/CD**'ni **Gitlab CI** yordamida yozamiz, keyin uni optimizatsiya qilish va kengaytirish ustida ishlaymiz, keyin esa **DEV, STAGE, PROD** environmentlar sozlab shunga moslab **Gitlab CI**'da **CI/CD**'lar yozamiz va buni kengaytirib boramiz. 

<Callout type="info" emoji="">
Amaliyotda ishlatilgan [**gitlab.com/devops-journey**](https://gitlab.com/ismoilovdev/devops-journey) repositoriya. **Gitlab CI** namuna fayllarni [**ismoilovdevml/devops-tools**](https://github.com/ismoilovdevml/devops-tools/tree/master/Gitlab)dan topishingiz mumkin.

Ushbu amaliyotda biz global [**gitlab.com**](https://gitlab.com/) dan foydalanamiz bu eslf-hosted deploy qilingan gitlab bilan deyarli bir xil agar siz o'zingizning serveringizga self-hosted **Gitlab** o'rnatmoqchi bo'lsangiz quyidagi qo'llanmani ko'rib chiqing - [**Gitlab Server o'rnatish va sozlash**](https://devops-journey.uz/guides/ci-cd/gitlab-server)
</Callout>

Boshlanishiga keling bir kichik amaliyotdan boshalymiz. Birinchi navbatda bitta gitlab repositoriya yaratib olamiz. **Create blank project** tanlab repositoriya ochish bo'limiga o'tamiz.
![gitlab-ci](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/gitlab-ci/1.png)

Bu qismda repositoriyani nomini kiritib repositoriyani yaratib olamiz masaln **gitlab-cicd-examples**
![gitlab-ci](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/gitlab-ci/2.png)
Repositoriyani xoxlagan IDE'yangizda yoki Gitlabning o'zining **WEB IDE**si orqali ochib olishingiz mumkin masaln menga ko'proq **WEB IDEA** qulayroq.
![gitlab-ci](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/gitlab-ci/3.png)
Repositoriyamizda `.gitlab-ci.yml` faylk ochib olib uni gitlabga push qilamiz.

```yaml filename=".gitlab-ci.yml" filename=".gitlab-ci.yml"
stages:
  - build
  - test
  - deploy

build_job:
  stage: build
  script:
    - echo "Building the project"
test_job:
  stage: test
  script:
    - echo "Running tests"

deploy_job:
  stage: deploy
  script:
    - echo "Deploying the application"
```

`gitlab-ci.yml` konfig file ochib yuqoridagi yaml configni kiritib gitlabga pushg qilganizdan keyin sizda joblar ishlab turganini ko'rishingiz mumkin.
![gitlab-ci](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/gitlab-ci/4.png)
Joblarni ko'k ikonka ustiga bosib yoki jobs bo'limidan ko'rishingiz mumkin
![gitlab-ci](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/gitlab-ci/5.png)
har bitta job ustiga bosib uning konsolini ochib jarayonlarni kuzatib borishingiz mumkin.
![gitlab-ci](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/gitlab-ci/6.png)
Okey bizda barcha joblarimiz muvaffaqiyatli yakunlandi
![gitlab-ci](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/gitlab-ci/8.png)

![gitlab-ci](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/gitlab-ci/7.png)

Keling endi bu qanday ishlagani nimaligini ko'rib chiqamiz.

`.gitlab-ci.yml` — bu **GitLab CI/CD** uchun konfiguratsiya fayli bo'lib, `pipeline`'ning ish tartibini belgilaydi. Fayl **YAML** formatida yoziladi va uning tuzilishi aniq va aniq tartibga rioya qiladi.  **Pipeline** — bu ketma-ket yoki parallel ravishda bajariladigan **job**lar to'plami. Har bir pipeline bosqichlardan iborat bo'lib, ular o'z navbatida job'ni o'z ichiga oladi.

`.gitlab-ci.yml` faylining asosiy printsipi

* Bosqichlar (`stages`) bir-birining ketidan ishlaydi.
* Job'lar qoidalar asosida bosqichlarda ishga tushadi.
* Buyruqlar (`script`) bajarilib, natijalar logga yoziladi.
* Artifacts va cache orqali natijalar yoki vaqtinchalik fayllar saqlanadi.
* Qoidalar (`rules`) yordamida job qaysi holatda ishlashi aniqlanadi.

Bu struktura har qanday pipeline'ni samarali va moslashuvchan qilish imkonini beradi.

## Struktura va asosiy elementlar

1. `stages`

Pipeline'dagi bosqichlar(stages) ro'yxatini belgilaydi. Har bir job qaysi bosqichda bajarilishini shu yerda ko'rsatilgan tartibga qarab aniqlaydi.

**Misol:**

```yaml filename=".gitlab-ci.yml"
stages:
  - build
  - test
  - deploy
```
Bu holatda, `build` bosqichi birinchi, undan keyin `test`, keyin esa `deploy` bajariladi.

2. `deafult`

Pipeline uchun `default` (standart) parametrlarni belgilaydi, masalan, `image`, `before_script`, yoki boshqa sozlamalar.

**Misol:**
```yaml filename=".gitlab-ci.yml"
stages:
  - build
  - test

default:
  image: python:3.9
  before_script:
    - pip install -r requirements.txt

build_job:
  stage: build
  script:
    - python setup.py build

test_job:
  stage: test
  script:
    - pytest tests/
```

3. `variables`

Global o'zgaruvchilarni aniqlaydi. Bu o'zgaruvchilar barcha jobs'larda ishlatiladi.
**Misol:**

```yaml filename=".gitlab-ci.yml"
variables:
  ENVIRONMENT: production
  TIMEOUT: 30
```
4. `jobs`
Job'lar pipeline'ning asosiy qismini tashkil qiladi va ularning tuzilishi quyidagicha:

```yaml filename=".gitlab-ci.yml"
stages:
  - build
  - test

build_job:
  stage: build
  script:
    - npm install
    - npm run build

test_job:
  stage: test
  script:
    - npm run test
```

**Job elementlari:**

* `job_name`: Jobning nomi. Bu foydalanuvchi tomonidan erkin belgilanadi.
* `stage`: Job qaysi bosqichda bajarilishini belgilaydi. stages bo'limida aniqlangan bosqichlardan birini tanlash kerak.
* `script`: Jobda bajariladigan buyruqlar ro'yxati. Bu buyruqlar ketma-ket bajariladi.
* `variables`: Job uchun maxsus o'zgaruvchilar. Global o'zgaruvchilarni ustiga yozib yuborishi mumkin.
* `rules`: Jobni bajarish qoidalarini belgilaydi (`if`, `changes`, `when`).
* `tags`: Runner'larni filtrlash uchun ishlatiladi. Faqat belgilangan teglar mos keladigan Runner'larda ishga tushadi.
* `artifacts`: Job natijalarini saqlaydi. Keyingi bosqichlarda foydalanish yoki yuklab olish uchun.
* `cache`: Oraliq natijalarni saqlash va qayta foydalanishni tezlashtiradi.


5. `before_script` va `after_script`

Job bajarilishidan oldin yoki keyin avtomatik ishlaydigan buyruqlarni belgilaydi.

**Misol:**

```yaml filename=".gitlab-ci.yml"
before_script:
  - echo "Setting up environment"

after_script:
  - echo "Cleaning up"
```

`image` - Joblar uchun Docker image belgilaydi. Agar pipeline Docker muhitida ishlasa, bu juda muhim.
Agar jobni bajarish uchun maxsus muhit kerak bo'lsa, masalan, Python, Node.js yoki boshqa texnologiyalar uchun tayyor Docker image ishlatiladi.
```yaml filename=".gitlab-ci.yml" /image/
stages:
  - test

test_job:
  stage: test
  image: python:3.9
  script:
    - pip install -r requirements.txt
    - pytest tests/
```

`services` - Job davomida qo'shimcha servicelar kerak bo'lsa, masalan, ma'lumotlar bazasi yoki kesh tizimi.
**Misol:**

```yaml filename=".gitlab-ci.yml" /services/
stages:
  - test

test_with_db:
  stage: test
  image: node:14
  services:
    - postgres:13
  variables:
    POSTGRES_DB: testdb
    POSTGRES_USER: user
    POSTGRES_PASSWORD: password
  script:
    - npm install
    - npm test
```

`dependencies` - Jobning oldingi job natijalaridan foydalanishini ta'minlaydi.

**Misol:**

```yaml filename=".gitlab-ci.yml" /dependencies/
stages:
  - build
  - test

build_job:
  stage: build
  script:
    - mkdir build
    - echo "build artifact" > build/artifact.txt
  artifacts:
    paths:
      - build/

test_job:
  stage: test
  script:
    - cat build/artifact.txt
  dependencies:
    - build_job
```

`rules` - Pipeline'ni optimallashtirish va faqat kerakli holatlarda jobni ishlatish uchun ishlatiladi. Jobni qachon va qaysi sharoitda bajarilishini belgilaydi.

**Misol:**

```yaml filename=".gitlab-ci.yml" /rules/
stages:
  - deploy

deploy_job:
  stage: deploy
  script:
    - echo "Deploying to production"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
```

## Pipeline Dizayni

Pipeline dizaynining asosiy maqsadi: jarayonlarni avtomatlashtirish, vaqtni optimallashtirish, va resurslardan samarali foydalanishni ta'minlash. Quyida stagelar, parallel jobs, triggerlar, va Dependencylarni sozlash haqida ko'rib chiqamiz.

**Bosqichlar (Stages)**
Pipeline bosqichlarga bo'linadi, bu jarayonlarni tartibga solishga yordam beradi. Har bir bosqich ma'lum bir vazifani bajaradi:

**Masalan:**

* `build`: dastur kodini build qilish.
* `test`: avtomatlashtirilgan testlarni bajarish.
* `deploy`: dastur yoki serviceni deploy qilish.

**Misol:
```yaml
stages:
  - build
  - test
  - deploy

# Build bosqichi
maven_build:
  stage: build
  script:
    - echo "Building the project..."
    - mvn clean package
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 week

# Test bosqichi
unit_tests:
  stage: test
  script:
    - echo "Running unit tests..."
    - mvn test

integration_tests:
  stage: test
  script:
    - echo "Running integration tests..."
    - mvn verify

# Deploy bosqichi
deploy_to_production:
  stage: deploy
  script:
    - echo "Deploying to production..."
    - scp target/*.jar user@production:/opt/app/
    - ssh user@production "systemctl restart app.service"
```
**Parallel Joblar**
Parallel joblar bir xil bosqichdagi vazifalarni bir vaqtning o'zida bajarishga imkon beradi. Bu katta hajmli jarayonlarni tezlashtirishga yordam beradi.

```yaml
stages:
  - test

parallel_tests:
  stage: test
  parallel:
    matrix:
      - TEST_ENV: "linux"
      - TEST_ENV: "windows"
      - TEST_ENV: "macos"
  script:
    - echo "Testing in $TEST_ENV environment..."
    - npm test
```
Yuqorida Testlar Linux, Windows va MacOS muhitlarida bir vaqtning o'zida bajariladi.

**Triggerlar**
Triggerlar pipeline jarayonlarini boshlash usullari:

* **Manual trigger:** Qo'lda ishga tushiriladi, odatda keyingi bosqichni tekshirish yoki monitoring talab qilinganda ishlatiladi.
* **Scheduled trigger:** Ma'lum vaqt oralig'ida avtomatik ishga tushiriladi (masalan, har kuni kechasi).
* **Triggered jobs:** Bir job yoki boshqa pipeline tomonidan chaqiriladi.

**Misol: Manual trigger**

```yaml filename=".gitlab-ci.yml"
deploy_to_staging:
  stage: deploy
  script:
    - echo "Deploying to staging..."
    - scp app.jar user@staging:/opt/app/
  when: manual
```

**Misol: Scheduled Trigger**

```yaml filename=".gitlab-ci.yml"
nightly_build:
  stage: build
  script:
    - echo "Starting nightly build..."
    - mvn clean package
  only:
    - schedules
```

**Dependency**

Job'lar orasidagi bog'liqlikni sozlash uchun `needs` parametridan foydalaniladi.

Masalan bu konfiguratsiyada `build_job` tugaganidan keyin `test_job` va undan keyin esa `deploy_job` ishlashnini belgilaydi.

```yaml filename=".gitlab-ci.yml"
build_job:
  stage: build
  script:
    - echo "Building application..."
    - mvn clean package

test_job:
  stage: test
  script:
    - echo "Running tests..."
    - mvn test
  needs:
    - build_job

deploy_job:
  stage: deploy
  script:
    - echo "Deploying application..."
    - scp target/*.jar user@production:/opt/app/
    - ssh user@production "systemctl restart app.service"
  needs:
    - test_job
```
Yuqorida `build_job` dastlab ishga tushadi keyin `test_job` faqat `build_job` muvaffaqiyatli tugaganidan keyin boshlanadi, `deploy_job` esa testlar tugallangandan so'ng ishga tushadi.

## Environment va secretlarni boshqarish

GitLab'da environment va secrets bilan ishlash, xavfsizlik va konfiguratsiya boshqaruvi uchun juda muhim. Quyida, ularni qanday boshqarish va ishlatish bo'yicha real-case misollar bilan tushuntirib beraman.

**Environment Variablelar** - bu pipeline davomida foydalaniladigan qiymatlar bo'lib, ular yashirin(protected) yoki umumiy bo'lishi mumkin.

GitLab'da o'zgaruvchilar ikki asosiy turga bo'linadi:

* **Protected Variablelar:** Faqat protected branchlarda (masalan, **main** yoki **production**) uchun ishlaydi.
* **Umumiy Variablelar:** Har qanday branch yoki environment uchun foydalaniladi.

GitLab'da secrets bilan ishlash maxfiy ma'lumotlarni boshqarish va ulardan xavfsiz foydalanishni ta'minlaydi. Secrets uchun bir nechta integratsiya usullari mavjud: **Vault, Kubernetes Secrets **GitLab Secrets** va boshqalar.

<Callout type="info" emoji="">
Secretlarni saqlashda Gitlab Secretsdan ko'ra [**Hashicorp Vault**](https://www.vaultproject.io/) tavsiya qilinadi!!!
</Callout>

Misol uchun Gitlab Secretsda ssh-keyni saqlab quyidagicha ishlatish mumkin. 

**-> Repositoriya -> Settings -> CI/CD -> Variables -> Add variable** ga o'tib key va valueni yozib sqalab ishlata olamiz

![gitlab-ci](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/gitlab-ci/9.png)
---------------
![gitlab-ci](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/gitlab-ci/10.png)

--------------
![gitlab-ci](https://raw.githubusercontent.com/devops-journey-uz/assets/main/images/tutorials/ci-cd/gitlab-ci/11.png)

`.gitlab-ci.yml` da quyidagicha ishlatish mumkin.

```yaml
stages:
  - deploy

deploy_job:
  stage: deploy
  script:
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh -T git@example.com
```

## Amaliyot CI/CD: Docker