import { Callout } from "nextra-theme-docs";

## Github Actions CI/CD

[**Github Actions**](https://github.com/features/actions) bu Github bilan integratsiya qilinga Githubning CI/CD va avtomatlashtirish dasturi hisoblanadi. Github Actions orqali Githubdagi loyihalaringizni oson avtomatlashtirishingiz, CI/CDlar yozish juda qulay, sodda, tez yoziladigan tez ishga tushadigan hisoblanadi.  Github Actions YAML sintaksisida yzoiladi va repositoriya root directoriyasida **./github/workflows** jildida yoziladi. Githubning yana bir qulaylikalridan biri uchuni loyihalaringiz uchun mo'ljallangan GHCR(Github Container Registry)si hisoblanadi. Loyihalaringizni konteynerda ishga tushirsangiz bu sizga yaxshi qulaykik beradi, yani siz bepul Container Registry ishlatasiz bu juda qulay.


## Ishni boshlash

Ushbu amaliyotda biz Github Actions va Github Container Registrydan foydalangan holda loyilarimizga CI/CD yozib deploymentni avtomlashtiramiz. Container Registry sifatida faqat Github Container Registry emas, balki Dockerhub va GCR(Google Container Registry)dan foydalanish uchun ham namuna Github Actionslar yozamiz. Amaliyotimiz soddaroq hech qanday testlarsiz va kood analizlarsiz ishga tushiramiz siz ularni o'zingiz kengaytirib qo'shib olamiz. Bugungi amaliyotimiz arixtekturasi tuzulishi quyidagicha **main** branchga o'zgarish bo'lganida avtomatik ishga tushadi va repositoriyani checkout qilib oladi loyidagi Dockerfile orqali loyiha docker imageni build qilib keshlab Container Registryga push qiladi keyingi CD bosqichida esa ssh orqali servverga kirib ynagi docker imageni pull qilib tortib olib eski shu nomli containerni to'xtatib o'chirib yangi containerni ishga tushirib qo'yadi va bu haqida discordga notification keladi.


## Github Actions CI

Amaliyotni boshlasak ham bo'ladi. Loyiahmiz root directoriyasida  Github Actions uchun **.github/workflows** papka ochib **ci-cd.yml** nomli yaml konfiguratsiya faylini ochib olamiz.

![github](/images/tutorials/ci-cd/github-actions/github.png)

Loyihalar har xil bo'ladi yani bitta repositoiyada bitta loyiha bo'ladi va unda bitta Dockerfile bo'ladi lekin ba'zi loyihlar bor ular bitta repositoiyada bir nechta loyihalar joylashgan bo'ladi masaln .NET(dotnet) loyihalar. Ushbu amaliyotda biz ikkala holat uchun Github Actionsda CI/CD yozamiz.

### Monorepo

Monorepo uchun [**devops-journey**](https://github.com/ismoilovdevml/devops-journey) loyihasini tanladik, bu holda bizda bitta repositoriyda butun loyihani o'zi va bitta Dockerfile bo'lib bitta Docker container orqali ishlaydi. keling ushbu amaliyotni boshlaymiz

Monorepo, bitta containerli loyihalar uchun **ci-cd.yml** configuratsiyamizning **CI** qismi quyidagicha bo'ladi.

```yaml
name: Github Actions CI/CD
 
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
 
env:
  REPO_NAME: ${{ github.repository }}
  CONTAINER_NAME: devops-journey
  REGISTRY: ghcr.io
 
jobs:
  build_and_push:
    runs-on: ubuntu-latest
    permissions:
        contents: read
        packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: "${{ env.REGISTRY }}/${{ env.REPO_NAME }}:${{ github.sha }}"
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.REPO_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.REPO_NAME }}:buildcache,mode=max
```

Keling ushbu Github actionni analiz qilib chiqamiz.

```yaml {3-7}
name: Github Actions CI/CD
 
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
```

**name** Bu Github Actiosnga berilgan nom. Koddagi belgilangan qism esa **Trigger** deb nomlanadi vazifasi **main** branchga commit push qilinsa yoki pull request merge qilinsa Github Actionsni avtomatik ishga tushirib beradi.

```yaml
env:
  IMAGE_NAME: ${{ github.repository }}
  CONTAINER_NAME: devops-journey
  REGISTRY: ghcr.io
```
Ushbu qism **Environment** qismi hisoblanadi bu qismga environmentlarimizni yozamiz.

* **REPO_NAME->** Docker image nomi bu holda repositoiya nomi olinadi.
* **CONTAINER_NAME->** Loyihamiz containeri nomi.
* **REGISTRY->** Bu qismda Container Registry url manzili beriladi GHCR uchun **ghcr.io**


```yaml
jobs:
  build_and_push:
    runs-on: ubuntu-latest
    permissions:
        contents: read
        packages: write
```
Workflow Ubuntu-ning latest versiyasida ishlaydigan **build_and_push** nomli bitta jobga ega. Ya'ni **build_and_push** nomli job **ubuntu:latest**da ishlaydi. **permissions** repositoriyani o'qishga va packagelarga yozish huquqini beradi.

```yaml
- name: Checkout code
  uses: actions/checkout@v3
```
Ushbu bosqich [actions/checkout@v3](https://github.com/actions/checkout)dan foydalanib repositoriyani checkout qilib klon qilib oladi.

```yaml
- name: Set up Docker Buildx
  uses: docker/setup-buildx-action@v3
```

Ushbu qadam **Docker Buildx**-ni o'rnatadi, bu Moby BuildKit builder toolkit tomonidan taqdim etilgan xususiyatlarni qo'llab-quvvatlash uchun Docker imkoniyatlarini kengaytiruvchi CLI plaginidir [docker/setup-buildx-action@v3](https://github.com/docker/setup-buildx-action)

```yaml
- name: Log in to the Container registry
  uses: docker/login-action@v3
  with:
    registry: ${{ env.REGISTRY }}
    username: ${{ github.actor }}
    password: ${{ secrets.GITHUB_TOKEN }}
```

Ushbu bosqichda **REGISTRY**ga **github.actor**ning **GITHUB_TOKEN**'ni bilan login qilib kiradi.

```yaml
- name: Build and push Docker image
  uses: docker/build-push-action@v5
  with:
    context: .
    push: true
    tags: "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
    cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME}}:buildcache
    cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.REPO_NAME}}:buildcache,mode=max
```

Ushbu bosqichda applicationimizdagi Dockerfile orqali applicationimiz docker image build qiladi va **github.sha** bilan tag qo'yib belgilangan Container Registryga push qiladi bu holda GHCRga. Ushbu bosqichda keshlash ham yoqilgan [docker/build-push-action@v5](https://github.com/docker/build-push-action)

Keling actoinimizni ishga tushirib sinab ko'raylik shuncahki ushbu o'zgarishlarni ushbu configuratsiyamizni main branchga psuh qilamiz va Github repositoriyamizdan **Actions** bo'limiga o'tib ko'rishimiz mumkin.

**Actions** bo'limidan Github Actionimiz ishlayotganini ko'rishimiz mumkin.
![github](/images/tutorials/ci-cd/github-actions/github2.png)
![github](/images/tutorials/ci-cd/github-actions/github3.png)
Okeyyy bizda Github Actionimiz muvaffaqiyat o'z ishini yakunladi.
![github](/images/tutorials/ci-cd/github-actions/github4.png)

Github Repositoriyamizdan **Packages** bo'limiga o'tsak build qilgan docker imageyimizni ko'rishimiz mumkin.
![github](/images/tutorials/ci-cd/github-actions/github5.png)

### Multi-container

Shunday applicationlar borki ular bitta repositoriydan ikkidan ortiq application bo'ladi masalan API va UI. Ushbu loyihlar uchun biz ikkita Dockerfile yozamiz ya'ni API.Dockerfile va UI.Dockerfile. Ushbu amaliyot uchun namuna sifatida **.NET 7** da yozilgan [devops-journey-uz/github-actions-dotnet](https://github.com/devops-journey-uz/github-actions-dotnet) applicartionni tanlab oldik. Bunda API uchun **API.Dockerfile** va UI uchun **UI.Dockerfile** yozilgan

Ushbu loyiha uchun Girthub Actionimiz quyidagicha o'zgaradi.

```yaml {10-13,38,42,48,52}
name: Github Actions CI/CD

on:
    push:
      branches: [ main ]
    pull_request:
      branches: [ main ]

env:
  API_IMAGE_NAME: github-api
  API_CONTAINER_NAME: github-api
  UI_IMAGE_NAME: github-ui
  UI_CONTAINER_NAME: github-ui
  
  REPO_NAME: ${{ github.repository }}
  REGISTRY: ghcr.io

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push API Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./API.Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.REPO_NAME}}/${{ env.API_IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.REPO_NAME}}/${{ env.API_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.REPO_NAME}}/${{ env.API_IMAGE_NAME }}:buildcache,mode=max

      - name: Build and push UI Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./UI.Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.REPO_NAME}}/${{ env.UI_IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.REPO_NAME}}/${{ env.UI_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.REPO_NAME}}/${{ env.UI_IMAGE_NAME }}:buildcache,mode=max
```

Ushbu konfiguratsiyamizda **file** ga Dockerfaylarimizni ko'rsatamiz. Shunga o'xshash loyihalar ko'pincha **.NET** bo'lgani uchun **.NET** loyiha tanlandi.

Keling Actionimizni ishga tushirib sinab ko'ramiz.

![github](/images/tutorials/ci-cd/github-actions/github6.png)

Repositoriyamizdan **Pacakages** bo'limiga o'tsak ikkita containerni ko'rishimiz mumkin
![github](/images/tutorials/ci-cd/github-actions/github7.png)

Hammasi zo'r Github Actionimiz muvaffaqiyat o'z ishini yakunladi endi CD serverga deploy qismini boshlasak bo'ladi

## Github Actions CD

Nihoyat biz so'ngi bosqich CD qismiga yetib keldik. Yuqorida biz bitta containerli va multi containerli applicationlarga CI qisqmini yozib tugadik. CI bosqichida Github Action berilgan Dockerfayllar orqali applicationlarimiz Docker imageni build qilib Github Container Registryga push qilib qo'ydi endi keyingi bosqichga o'tamiz. CD bosqichida berilgan `SERVER_IP`, `SERVER_USERNAME` va `SSH_PRIVATE_KEY` orqali serverga ssh orqali CI tomonidan push qilib joylab qo'yilgan Docker imagelarni pull qilib tortib oladi va eski shu nom bilan ishlab turgan containerlarni to'xtatib, o'chirib pull qilib olingan yangi docker containerni berilgan nom bilan, berilgan portda ishga tushirib qo'yadi va o'z ishini yakunlaydi. Keyingi bosqichda Notificationlar uchun Discord bilan integratsiya qilamiz.

[**devops-journey**](https://github.com/ismoilovdevml/devops-journey) loyihasi uchun yani bitta containerli loyihalar uchun CD qism quyidagicha bo'ladi.


```yaml {13-16,48-66}
name: Github Actions CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REPO_NAME: ${{ github.repository }}
  CONTAINER_NAME: devops-journey
  REGISTRY: ghcr.io
  SSH_HOST: ${{ secrets.SERVER_IP }}
  SSH_USER: ${{ secrets.SERVER_USERNAME }}
  SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  PORT: 3000:3000

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: "${{ env.REGISTRY }}/${{ env.REPO_NAME }}:${{ github.sha }}"
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.REPO_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.REPO_NAME }}:buildcache,mode=max

  
  deploy:
    needs: build_and_push
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Executing remote SSH commands to deploy
        uses: appleboy/ssh-action@master
        with:
          host: "${{ env.SSH_HOST }}"
          username: "${{ env.SSH_USER }}"
          key: "${{ env.SSH_KEY }}"
          script: |
            echo ${{ secrets.GITHUB_TOKEN }} | docker login -u ${{ github.actor }} --password-stdin ${{ env.REGISTRY }}
            docker pull "${{ env.REGISTRY }}/${{ env.REPO_NAME }}:${{ github.sha }}"
            docker stop "${{ env.CONTAINER_NAME }}" || true
            docker rm "${{ env.CONTAINER_NAME }}" || true
            docker run -d --name "${{ env.CONTAINER_NAME }}" -p "${{ env.PORT }}" "${{ env.REGISTRY }}/${{ env.REPO_NAME }}:${{ github.sha }}"
```

Keling ushbu o'zgarishlarnin o'rganib chiqamiz.

Environment qismiga quyidagi o'zgarishlarni qo'shdik.

```yaml {5-8}
env:
  REPO_NAME: ${{ github.repository }}
  CONTAINER_NAME: devops-journey
  REGISTRY: ghcr.io
  SSH_HOST: ${{ secrets.SERVER_IP }}
  SSH_USER: ${{ secrets.SERVER_USERNAME }}
  SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  PORT: 3000:3000
```

Github Actions serverimizga ssh bilan kira olish uchun server static IP manzili, server useri va ssh-private key kerak bo'ladi. Buning uchun biz Github repositoriyamizga secretlarni qo'shib qo'yishimiz kerak. 

**1->** Repositoriyaga kirib Settings bo'limiga o'tib **-> Secrets and variables -> Actions -> New repository secret**ga o'tib secretlar yaratib olamiz.

**-> Repository -> Settings -> Secrets and variables -> Actions -> New repository secret**

![k8s](/images/tutorials/ci-cd/k8s/gitops1.png)

* **SERVER_IP->** Bunga serverimiz static IP manzilini yozamiz. `0.0.0.0` o'rniga static IP manzil yozing

![github](/images/tutorials/ci-cd/github-actions/github8.png)
* **SERVER_USERNAME->** Ushbu secretga serverimiz usernameni yozishimiz kerak bo'ladi, server usernamesin bilish uchun `whoami` buyrug'idan foydalanishingiz mumkin.
![github](/images/tutorials/ci-cd/github-actions/github9.png)

* **SSH_PRIVATE_KEY->** Bu secetga esa serverimizda ssh-key generatsiya qilib ssh private keyni qo'yamiz github actions ssh orqali serverimizga kira olishi uchun.

**1->** Serverimizda ssh-key generatsiya qilib olamiz.

```bash
ssh-keygen -f ~/.ssh/github_actions
```
![github](/images/tutorials/ci-cd/github-actions/ssh.png)
ushbu buyruq **~/.ssh** papkada `github_actions` nomli ssh-key generatsiya qiladi bunda ikita key bo'ladi `github_actions` bu private key va `gihub_actions.pub` bu public key hisoblanadi. Github Actionsda ishlatish uchun public keyimizni `authorized_keys`ga qo'shib qo'yishimiz kerak. Buning uchun quyidagi buyruqdan foydalanamiz.

```bash
cat github_actions.pub >> authorized_keys
```
**2->** `github_actions` private keyimizni cat bilan ochib uni nusxalab Github Secretsga `SSH_PRIVATE_KEY`ga qo'shib qo'yamiz.

Private keyni olish uchun.
```bash
cat github_actions
```
![github](/images/tutorials/ci-cd/github-actions/ssh1.png)

Private keyni joylashtiramiz.
![github](/images/tutorials/ci-cd/github-actions/github10.png)