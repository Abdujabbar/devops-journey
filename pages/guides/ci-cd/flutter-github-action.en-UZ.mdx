import { Callout } from "nextra-theme-docs";

# Github Actions bilan Flutter CI/CD

![flutter-ci-cd](/images/tutorials/ci-cd/flutter-cicd/banner.png)

CI/CD ni ko'p hollarda Docker yoki web ilovalar uchun yozilganini ko'p ko'rganmiz lekin mobil dasturlar uchun yozilganini kam ko'rganmiz. Bugun biz Flutterda yozilgan dasturlarga **Flutter CI/CD yozamiz**. Bu juda qiziq bo'ladi va biz Discord bilan integratsiya qilamiz yani gitga push qilganimizda pull requestlarni merge qilganimizda yoki pull requestlar kelsa va CI/CD action fail yoki succses bo'lganida discordga notification yuborib turadigan qilib sozlaymiz. Keling ishni Discord bila integratsiya qilishdan boshlaymiz.

<Callout type="info" emoji="">
Amaliyotda ishlatilgan [**devops-journey-uz/flutter-ci-cd**](https://github.com/devops-journey-uz/flutter-ci-cd) repositoriya. Github Actions namuna fayllarni [**ismoilovdevml/devops-tools**](https://github.com/ismoilovdevml/devops-tools/tree/master/Github-Actions)dan topishingiz mumkin.
</Callout>


## Discord bilan integratsiya

Biz loyihamizni discord bilan integratsiya qilish uchun `Discord webhook` dan foydalanamiz. Discord bilan integratsiya qilishda Discord server ochib olishimiz va serverda channel ochishimiz kerak. 

<Callout type="info" emoji="">
Discord channel ochish va Discord webhook olib Githubdagi loyiha bilan integratsiya qilish bo'yicha quyidagi [video qo'llanmani](https://youtu.be/-KDQqWNK3Tw?si=L8YYPAX4RKVi1ACa) ko'rib chiqishingiz mumkin.
</Callout>

## Github Actions CI

Keling boshlanioshiga oddiy **CI** yozamiz. CI quyidagicha ishlaydi **main** branchda o'zgarish bo'lganda yoki pull request tushganda avtomatik ishga tushadi. Github Actionsni **macos** runnerda ishlashi va bir nechta build bo'lishini belgilaymiz, yani **apk --debug, appbundle --debug, ios --no-codesign , macos va web**. Birinchi navbatda loyihamizda **.github** nomli papka ochib ichida yana bitta **workflows** papka ochib ichiga **build.yml** YAML konfiguratsiya fayl ochib olamiz va quyidagicha konfiguratsiya qilamiz.

```bash filename=".github/workflows/release.yml"
name: Builds

on:
    push:
      branches: [ main ]
    pull_request:
      branches: [ main ]

permissions: read-all

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        target: ["apk --debug", "appbundle --debug", "ios --no-codesign", macos, web]
    steps:
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: 11
          distribution: temurin

      - name: Clone Flutter repository with stable channel
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.9'
          channel: 'stable'
      - run: flutter doctor -v

      - name: Checkout Code
        uses: actions/checkout@v4
      - run: flutter pub get

      - run: flutter build ${{ matrix.target }}
```

Ushbu konfiguratsiyalarni qo'shib **main** branchga push qilganimizda avtomatik Github Actionimiz ishga tushishi kerak buni  repositoriyamiz **Actions** bo'limidan ko'rishimiz mumkin.

![flutter-ci-cd](/images/tutorials/ci-cd/flutter-cicd/actions1.png)
![flutter-ci-cd](/images/tutorials/ci-cd/flutter-cicd/actions2.png)
![flutter-ci-cd](/images/tutorials/ci-cd/flutter-cicd/actions3.png)

Bizda hammasi muvaffaqiyatli build bo'ldi.
![flutter-ci-cd](/images/tutorials/ci-cd/flutter-cicd/actions4.png)

Keling endi ushbu YAML konfiguratsiyamizni bo'laklarga bo'lib o'rganib chiqamiz.


```bash {3-7}
name: Builds

on:
    push:
      branches: [ main ]
    pull_request:
      branches: [ main ]
```

Ushbu qimsda birinchi qator Action nomini belgilaydi bu holda bizda **Builds** bo'ladi. Keyingi  Belgilangan qism esa **Trigger** deb nomlanadik, ya'ni loyihamiz repositoriyasi **main** branchga commit bo'lib o'zgarish bo'lganida va yoki pull request kelib tushganda avtomatik Github Actions ishga tushishini bildiradi.

```bash
permissions: read-all
```

Bu esa Github Actions ushbu repositoriyada barchasiga faqat read(o'qish) ruxsatini qo'shadi.

```bash
jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        target: ["apk --debug", "appbundle --debug", "ios --no-codesign", macos, web]
```

Ushbu qism **build** nomli **macos-latest** runnerda ishlaydigan jobni belgilaydi. Buni **matrix** strategiya orqali ishga tushiradi. Matrix **apk --debug, appbundle --debug, ios --no-codesign , macos va web** build targetlarni o'z ichiga oladi. **macos-latest** runner tanlanganinin sabba ios va macos uchun build qilish uchun.

```bash
steps:
  - name: Set up JDK 11
    uses: actions/setup-java@v4
    with:
      java-version: 11
      distribution: temurin
```

Bu qism [actions/setup-java@v4](https://github.com/actions/setup-java) orqali Java Development Kitning 11 temurin distributioni o'rnatadi

```bash
- name: Clone Flutter repository with stable channel
  uses: subosito/flutter-action@v2
  with:
    flutter-version: '3.16.9'
    channel: 'stable'
- run: flutter doctor -v
```
Bu qism [subosito/flutter-action@v2](https://github.com/subosito/flutter-action) orqali Flutterning **3.16.9 stable** versiyasini o'rnatadi. `run: flutter doctor -v` esa flutter environmentni tekshiradi.


```bash
  - name: Checkout Code
    uses: actions/checkout@v4
  - run: flutter pub get
```

Bu qism [actions/checkout@v4](https://github.com/actions/checkout) orqali loyiha kodlarni klon qilib oladi `flutter pub get` orqali loyiha dependencilarini o'rnatadi.  

```bash
- run: flutter build ${{ matrix.target }}
```
Ushbu bochqichda matrixda berilgan targetlar bilan `flutter build` buyrug'ini macos-latest runnerda ishga tushiradi.

## Github Release

Yuqorida flutter loyihani build qilib tekshiradigan **Github Actions CI** yozgan edik, Keling endi Github Release bilan ishlaydigan **CI/CD** yozamiz.
**.github/workflows** papkasida **release.yml** konfiguratsiya fayl ochamiz. 

Mana bizning **release.yml** Github Release bilan ishlaydigan Android CI/CD konfiguratsiyamiz.

```bash
name: Test, Build and Release APK

on:
  push:
    branches: 
      - main
  pull_request:
    branches: 
      - main

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17.x'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.9'
          channel: 'stable'

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Get dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release

      - name: Create a Release APK
        uses: ncipollo/release-action@v1
        with:
          artifacts: "build/app/outputs/flutter-apk/*.apk"
          token: ${{ secrets.PERSONAL_TOKEN }}
          commit: main
          tag: v1.0.${{ github.run_number }}
```

Ushbu Github Actions konfiguratsiya orqali Github Release bilan ishlash uchun loyihamiz repositoriyasiga `PERSONAL_TOKEN` nomli secret ochib github personal tokenimizni joylashtiramiz. GitHub personal accsess token olish uchun quyidagi qo'llanmadan foydalanishingiz mumkin [**GitHub Personal Access Token**](https://devops-journey.uz/guides/ci-cd/jenkins-docker-ci-cd#github-uchun).

Repositoriyaga kirib Settings bo'limiga o'tib **-> Secrets and variables -> Actions -> New repository secret**ga o'tib secretlar yaratib olamiz.

**-> Repository -> Settings -> Secrets and variables -> Actions -> New repository secret**

![k8s](/images/tutorials/ci-cd/k8s/gitops1.png)

![flutter-ci-cd](/images/tutorials/ci-cd/flutter-cicd/secret.png)

Github Secretsga PERSONAL_TOKEN tokenimizni qo'shib qo'yagnimzidan keyin **release.yml** konfiguratsiyani **main** branchga push qilamiz. Github Repositoiyamiz **Actions** bo'limiga o'tib Github Actionsni kuzatib borishimiz mumkin.

