import { Callout } from "nextra-theme-docs";

# Kubespray yordamida production uchun Kubernetes Cluster sozlash

![kubespray](/images/tutorials/k8s/kubespray/banner.png)

## Kirish

Bundan oldi biz [**Kubernetes klaster yaratish va sozlash(kubeadm)**](https://devops-journey.uz/guides/k8s/k8s-cluster-setup) qo'llanmasida biz **on-premises** serverlarda **kubeadm** yordamida Kubernetes yaratib ishlashga tayyorlagandik. Bugun biz **Kubespray** yordamida **Production** uchun Kubernetes cluster sozlab ishlashgacha tayyorlaymiz.


[**Kubespray**](https://kubespray.io/#/) - Ansibleda qurilgan [**open-source**](https://github.com/kubernetes-sigs/kubespray) loyiha bo'lib, Kubernetes klasterni oson deploy qilish va boshqarishni avtomatlashtirish uchun mo'ljallangan Ansible playbook hisoblanadi.

## Ishni boshlash

Bugungi amaliyotda biz Kubespray yordamida production uchun Kubernetes cluster sozlab ishga tushiramiz, biz bunda **Kubespray, Helm, NGINX Ingress, Flannel, Promethus/Grafana, Longhorn, Certmanager** va boshqa toollardan foydalanmiz.

Amaliyot uchun minimum 4-ta server kerak bo'ladi, ya'ni bitta Ansible server va 3-ta minimum Kubernetes klaster uchun serverlar.

<Callout type="info" emoji="">

Ushbu amaliyot uchun kerak bo'ladigan serverlar.

**Minimum Server talabi**

| OS            | RAM            | CPU           | Xotira       | Static IP  | Server nomi  |
| ------------- | -------------- | ------------- |------------- | ---------- | -----------  |
| Ubuntu 20.04  | 4GB            | 2vCPU 1 core  | 50GB         | Ha kerak   | ansible-server |
| Ubuntu 20.04  | 8GB            | 8vCPU 4 core  | 50GB         | Ha kerak   | k8s-master   |
| Ubuntu 20.04  | 4GB            | 4vCPU 2 core  | 50GB         | shart emas | k8s-node1    |
| Ubuntu 20.04  | 4GB            | 4vCPU 2 core  | 50GB         | shart emas | k8s-node2    |

Umumiy hisobda bizga 4-ta server, bitta ansible server va 3-ta k8s klaster uchun server(k8s-master,k8s-node1,k8s-node2) kerak bo'ladi.
</Callout>

## Network sozlash

Kubernetes klaster sozlash uchun birinchi navbatda Kubernetes klaster uchun Network sozlab olishimiz kerak bo'ladi. Har qanday muhit uchun Cloud yoki on--premises bo'ladimi subnet sozlab olish kerak bo'ladi va yuqorida ko'rsatilgan barcha serverlar bitta subnetda bo'lishi kerak chunki ular bir-biri bilan local tarmoqda **Internal IP**lar bilan bog'lanib ishlaydi.

Ushbu amaliyotda biz **172.23.0.15/24** IP range(diapazon)li subentdan foydalandik va biz Google Cloud Serverlaridan foydalandik. Serverlar Internal IP'lariga e'tibor berib qarang ular hammasi **172.23.0.0/24** subnetda va ular bir bir bilan local tarmoq orqali bo'glanaib ishlay oladi. Siz Cloud ishlatasizmi yoki on-premises buni ahamiyati yo'q, bu yerda e'tibor berish kerak bo'lgan narsa bu Subnet local tarmoq hisoblanadi.

![kubespray](/images/tutorials/k8s/kubespray/server.png)

Agar siz **Microsoft Azure** yoki **Google Cloud** ishlatadigan bo'lsangiz platformamizda **Azure** va **GCP**'da Network sozlash qo'llanmalarimizni ko'rib chiqishingiz mumkin.

**->** [**Azure Network sozlash**](https://devops-journey.uz/guides/cloud/azure-network-sozlash)
![azure-network-sozlash](/images/tutorials/cloud/azure-network/architecture.png)

**->** [**GCP Network sozlash**](https://devops-journey.uz/guides/cloud/gcp-network-sozlash)
![gcp-network-sozlash](/images/tutorials/cloud/gcp-network/vpc-architecture.png)

## Ansible server sozlash

Kubernetes klaster uchun Network sozlab olganimizdan keyin Kubesprayni ishga tushirish uchun Ansible server solzab olishimiz kerak bo'ladi.

**1->** Ansible serverimizni yangilab kerakli utilatalarni o'rnatib olamiz.

```bash
sudo apt update && sudo apt upgrade -y
sudo apt-get install software-properties-common ca-certificates curl gnupg zip unzip -y
```
**2->** Python o'rnatib olamiz.

Custom APT repositoriyani qo'shib olamiz 
```bash
sudo add-apt-repository ppa:deadsnakes/ppa
sudo apt update
```
Python **3.10(venv,dev)** o'rnatamiz
```bash
sudo apt install python3.10 python3.10-venv python3.10-dev
python3 --version
```

symbolic link yaratib olamiz
```bash
ls -la /usr/bin/python3
sudo rm /usr/bin/python3
sudo ln -s python3.10 /usr/bin/python3
python3 --version
```
Python paket manageri **pip** o'rnatamiz.
```bash
curl -sS https://bootstrap.pypa.io/get-pip.py | python3.10
python3 -m pip --version
```

**3->** **Ansible** o'rnatamiz.

```bash
sudo add-apt-repository --yes --update ppa:ansible/ansible
sudo apt install ansible -y
```

Ansible serverimzida Ansible va Python o'rnatib olganimizdan keyin Kubesprayni sozlashni boshlasak bo'ladi. 

Kubespray github repositoriyasidan [**Releases**](https://github.com/kubernetes-sigs/kubespray/releases)'ga o'tib latest versiyani **.zip** yuklab olamiz.

```bash
sudo wget https://github.com/kubernetes-sigs/kubespray/archive/refs/tags/v2.24.1.zip
```
Kubesprayni zipdan chiqarib olamiz va papka nomini kubespray'ga o'zgartiramiz.

```bash
sudo unzip v2.24.1.zip
mv kubespray-2.24.1/ ./kubespray
```
![kubespray](/images/tutorials/k8s/kubespray/ansible1.png)

Kubespray ansible playbookni ishga tushirish uchun ansible-serverimiz boshqa serverlarga **internal IP**lari orqali **root** userga **ssh** orqali ulana olishi kerak, shuning uchun **ansible-server**da ssh-key generatsiya qilib uni **public** keyini boshqa serverlarda **root** userga kirib **authorized_keys**ga qo'shib qo'yishimiz va **ansible-server**dan turib ssh ulanishni tekshirib ko'rishimiz kerak.

ansible-serverimizda root userga kirib  ssh key generatsiya qilamiz.

```bash
sudo su
ssh-keygen
```
![kubespray](/images/tutorials/k8s/kubespray/ssh.png)

ssh papkaga kirib **id_rsa.pub** public keyni cat bilan chiqarib olib uni buferga nusxalab olamiz va boshqa serverlarimizda root userdan kirib authorized_keys'ga qo'shib qo'yamiz.

Ansible serverda:
```bash
cd ~/.ssh/
ls
cat id_rsa.pub
```

Boshqa serverlarda:

```bash
sudo su
cat >> ~/.ssh/authorized_keys <<EOF
bu yerga ansible serverdan olgan id_rsa.pub ssh-keyimizni joylashtiramiz
EOF
```

ansible server public ssh keyini boshqa serverlar authoirized_keys fayliga qo'shib bo'lganimizdan keyin ansible-serverdan turib root user bilan boshqa sereverlar internal IP lari orqali ssh ulanishni tekshiramiz.

Ansible serverdan:

```bash
ssh root@172.23.0.16
ssh root@172.23.0.17
ssh root@172.23.0.18
```

Okeey hammasiga root user bilan Internal IP'lari orqali ssh bilan ulana olganimizdan keyin kubesprayni solashni boshlasak bo'ladi.

Kubesprayni ishga tushirishdan oldin kubespray uchun python venv yaratib kerakli python paketlarni o'rnatib olamiz.

Ansible serverda:

```bash
VENVDIR=kubespray-venv
KUBESPRAYDIR=kubespray
python3 -m venv $VENVDIR
source $VENVDIR/bin/activate
cd $KUBESPRAYDIR
pip install --upgrade pip
pip install -U -r requirements.txt
```
![kubespray](/images/tutorials/k8s/kubespray/ansible2.png)

Kubespray uchun kerakli paketlarni o'rnatib olganimizdan keyin `/kubespray/inventory/sample` papkadan o'zimizga klaster sozlab olamiz. Biz bu yerda `mycluster` nomli papkaga sample papkadagi kerakli fayllarni ko'chiramiz.

```bash
cp -rfp inventory/sample inventory/mycluster
```
Bu buyruq `inventory.py` script orqali berilgan IP manzillarni dinamik tarzda **hosts.yaml** ga yozib chiqadi.
```bash
declare -a IPS=(172.23.0.16 172.23.0.17 172.23.0.18)
CONFIG_FILE=inventory/mycluster/hosts.yaml python3 contrib/inventory_builder/inventory.py ${IPS[@]}
```

Tekshirib ko'rish uchun, bu yerda biz kiritgan serlerimiz IP'lari bo'lishi kerak.

```bash
cat inventory/mycluster/hosts.yaml
```

Kubesprayni deyarli ishlash tayyor, endi ba'zi konfiglarni ko'rib cghiqamiz. Kubespray default holda Network uchun **Calico** ishlatadi siz o'z talablaringizga mos ravishda uni o'zgartirishingiz mumkin, biz bu amalaiyotda **calico** o'rniga **flannel** ishlatamiz.

Calicodan flannela o'zgartirish uchun `k8s-cluster.yml` faylidan o'zgartiramiz.

```bash
nano inventory/mycluster/group_vars/k8s_cluster/k8s-cluster.yml
```
![kubespray](/images/tutorials/k8s/kubespray/kubespray1.png)

keyin `addons.yml` konfiguratsiya faylidan **helm** o'rnatishni yoqib qo'yamiz. `addons.yml` konfiguratsiya faylidan kerakli Kubernetes addonslarni sozlab olsangiz bo'ladi.

```bash
nano inventory/mycluster/group_vars/k8s_cluster/addons.yml
```
![kubespray](/images/tutorials/k8s/kubespray/kubespray2.png)

Okeyy bizda hammasi tayyor Kubesprayni ishga tushirsak bo'ladi

```bash
ansible-playbook -i inventory/mycluster/hosts.yaml  --become --become-user=root cluster.yml
```