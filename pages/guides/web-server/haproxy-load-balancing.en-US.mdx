import { Callout } from "nextra-theme-docs";

## HAProxy bilan trafficni HTTP/TCP load balancing qilish

![haproxy](/images/tutorials/web-server/haproxy/banner.png)

**HAProxy** yoki **H**igh **A**vailability **P**roxy - bu yuqori samarali(high-performance) **TCP/HTTP** load balancer va proksi-server sifatida ishlaydigan open-source dasturiy ta'minot. U kiruvchi trafikni(incoming traffic) bir nechta serverlar yoki backend tizimlari bo'ylab taqsimlashda muhim rol o'ynaydi, optimal resurslardan foydalanishni, high availabilityni va web-applicationlar uchun kengaytirilishini(scalability) ta'minlaydi.

**HAProxy** client va server o'rtasida joylashgan reverse proxy sifatida ishlaydi. U kiruvchi client so'rovlarini(request) ushlab turadi va ularni oldindan belgilangan qoidalar(rules) va algoritmlar to'plami asosida tegishli backend serveriga yo'naltiradi. Ushbu jarayon **HAProxy**-ga bir nechta serverlar bo'ylab yukni(load) samarali muvozanatlash imkonini beradi, bu esa har qanday bitta serverning ishlamay qolishining oldini oladi, shu bilan birga barqaror(consistent) va responsive service deliveryni ta'minlaydi.

HAProxy ning muhim kuchli tomonlaridan biri uning moslashuvchanligi(flexibility) va sozlanishidadir(configurability). U keng ko'lamli konfiguratsiya opsiyalarini taklif qiladi va turli xil load balancing algoritmlarini qo'llab-quvvatlaydi, shu jumladan **Round Robin**, **Least Connections**, **Source IP Hash**, **Weighted Round Robin**, **Weighted Least Connections**. Ushbu ko'p qirralilik devops/adminlarga maxsus dastur talablariga mos(application specific) keladigan load-balancing behaviorini sozlash imkonini beradi.

Bundan tashqari, HAProxy HTTP headerlari, cookielar va URL yo'llari(path) kabi complex mezonlar(criteria) asosida SSL termination, content switching, health check va so'rovlarni yo'naltirish(request routing) kabi advanced xususiyatlarni taqdim etadi. Bu xususiyatlar devops/adminlarga murakkab trafik boshqaruvini amalga oshirish va web servicelarni yetkazib berishni optimallashtirish imkonini beradi.

Bundan tashqari, HAProxy-ning low latency(past kechikish) bilan yuqori trafik(high traffic) hajmlarini boshqarish qobiliyati uni web applicationlar uchun high availability va performanceni ta'minlashni istagan ko'plab tashkilotlar uchun afzalroq tanlov qiladi. U ko'pincha turli xil deployment senariylarida, jumladan **C**ontent **D**elivery **N**etworklarida (**CDN**), web hosting environmentda,cloud infrastructurelarda va yirik korporativ(enterprise) sozlashlarda qo'llaniladi.

O'zining mustahkamligi(robustness), moslashuvchanligi(adaptability) va katta hajmdagi trafikni boshqarish qobiliyati bilan HAProxy ko'plab applicationlar va servicelar uchun muhim web infrastructureni qo'llab-quvvatlovchi ishonchli va samarali load balanceri va proxy server yechimi sifatida industryda keng qo'llanildi.

<Callout type="info" emoji="">
**ESLATMA->** Ushbu qo'llanma mazmuni yaxshi tushunish uchun bundan oldingi **[Load Balancing](https://devops-journey.uz/guides/web-server/load-balancing)** va **[NGINX Load Balancing](https://devops-journey.uz/guides/web-server/nginx-load-balancing)** qo'llanmalarini o'qib chiqishingiz kerak!
</Callout>


## Ishni boshlash va HAProxy o'rnatish

HAProxy bilan load balancing qilishimiz uhcun minimum 3ta server kerak bo'ladi bitta HAProxy load balancer server va 2ta backend application server.

<Callout type="info" emoji="">
**Minimum Server talabi**

| OS            | RAM            | CPU           | Xotira       | Static IP  |  Server vazifasi       |
| ------------- | -------------- | ------------- |------------- | ---------- | ---------------------- |
| Ubuntu 20.04  | 4GB            | 2vCPU 2 core  | 50GB         | Ha kerak   | HAProxy(Load Balancer) |
| Ubuntu 20.04  | 4GB            | 2vCPU 2 core  | 50GB         | Shart emas | Application Server 1   |
| Ubuntu 20.04  | 4GB            | 2vCPU 2 core  | 50GB         | Shart emas | Application Server 2   |

**Qo'llanmada ishlatilgan Serverlar IP mazilllari**

| Server                 | IP manzili   | 
| ---------------------- | ------------ |
| HAProxy(Load Balancer) | 185.168.1.20 |
| Application Server 1   | 185.168.1.21 |
| Application Server 2   | 185.168.1.22 |

</Callout>

**HAProxy** serverimizni sozlashni boshlaymiz.
**1.** Tizimingizni yangilang.

```bash
sudo apt-get update && sudo apt-get upgrade -y
```

**2.** HAProxy o'rnating. HAProxy ko'pgina Linux distributivlarining package management systemlariga kiritilgan:

Debian based uchun. Debian va Ubuntu uchun maxsus HAProxy versiylarini o'rnatish uchun quyidagi websaytdan foydalanishingiz mumkin. [haproxy.debian.net](https://haproxy.debian.net/)

```bash
sudo apt install haproxy -y
```
Fedora uchun

```bash
sudo yum install haproxy
```

**3.** HAProxy o'rnatilganidan keyin statusini tekshiring.

```bash
sudo systemctl status haproxy
sudo systemctl enable haproxy
```
## HAProxy boshlang'ich konfiguratsiya.

HAProxy'ni serverimizga muvafaqqiyatli o'rnatib ishga tushirganimizdan keyin load balancer sifatida konfiguratsiya qilishni boshlasak bo'ladi. O'rnatish vaqtida avtomatik ravishda yaratiladigan `/etc/haproxy/haproxy.cfg` manzilidagi default konfiguratsiya faylini ko'rib chiqing. Ushbu fayl hech qanday load balancersiz standart sozlashni belgilaydi:

```bash filename="/etc/haproxy/haproxy.cfg"
global
	log /dev/log	local0
	log /dev/log	local1 notice
	chroot /var/lib/haproxy
	stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
	stats timeout 30s
	user haproxy
	group haproxy
	daemon

	# Default SSL material locations
	ca-base /etc/ssl/certs
	crt-base /etc/ssl/private

	# See: https://ssl-config.mozilla.org/#server=haproxy&server-version=2.0.3&config=intermediate
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
	log	global
	mode	http
	option	httplog
	option	dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000
	errorfile 400 /etc/haproxy/errors/400.http
	errorfile 403 /etc/haproxy/errors/403.http
	errorfile 408 /etc/haproxy/errors/408.http
	errorfile 500 /etc/haproxy/errors/500.http
	errorfile 502 /etc/haproxy/errors/502.http
	errorfile 503 /etc/haproxy/errors/503.http
	errorfile 504 /etc/haproxy/errors/504.http
```

**HAProxy** konfiguratsiya fayli (ko'pincha `haproxy.cfg` deb nomlanadi) ikkita asosiy bo'limdan iborat: **global** va **default**. global section butun **HAProxy** jarayoniga taalluqli sozlamalarni belgilaydi, default bo'lim esa ma'lum frontend yoki backend bo'limlarida bekor qilinmasa, frontend va backendlar uchun default parametrlarni o'rnatadi.

### global section

* **log /dev/log local0** va **log /dev/log	local1 notice ->** Logga kirish manzillari va darajalarini belgilaydi. Log messagelari turli log darajalariga(log level) ega **local0** va **local1** obyektlariga yuboriladi (**lokal1** uchun eslatma).

* **chroot /var/lib/haproxy->** HAProxy fayl tizimi koʻrinishini(filesystem view) cheklash orqali xavfsizlikni oshirish uchun **chroot** directoryni oʻrnatadi.

* **stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners->** Statistika uchun UNIX socketini sozlaydi. Bu tashqi dasturlarga (monitoring toollar kabi) HAProxy bilan o'zaro ta'sir qilish imkonini beradi.

* **stats timeout 30s->** Statistik so'rovlar(requestlar) uchun kutish vaqtini(timeout) 30 soniyagacha belgilaydi.

* **user haproxy va group haproxy->** HAProxy ishlaydigan foydalanuvchi(user) va guruhni(group) belgilaydi.

* **daemon->** HAProxy-ga fonda demon sifatida ishlashni buyuradi.

* **ca-base va crt-base->** SSL sertifikatlari va kalitlari(key) uchun default manzillar.

**SSL bilan bog'liq konfiguratsiyalar**

* **ssl-default-bind-ciphers va ssl-default-bind-ciphersuites->** Kiruvchi ulanishlar(incoming connection) uchun ruxsat etilgan SSL shifrlari va shifrlar to'plamini o'rnatadi.

* **ssl-default-bind-options->** Standart ulanish uchun **SSL/TLS** opsiyalarini sozlaydi. U minimal **TLS** versiyasini **TLSv1.2** sifatida belgilaydi va **TLS** session ticketlarini o'chiradi.

### default section

* **log	global** Loglar global logging manzillariga yuborilishi kerakligini bildiradi.
* **mode	http** Modeni HTTP sifatida belgilaydi, bu HAProxy HTTP proksi-server sifatida ishlashini ko'rsatadi(HTTP Load Balancing).
* **option	httplog** HTTP so'rovlari(request) va javoblarini(response) logga yozishni yoqadi.
* **option	dontlognull** dontlognull directive opsiyasi tizimga hech qanday ma'lumot o'tkazmaydigan ulanishlarni logga yozmaslikni buyuradi. Boshqacha qilib aytadigan bo'lsak, u health check tekshiruvlari yoki haqiqiy HTTP so'rovlarini o'z ichiga olmaydigan ulanishlarni loglarga yozmaslikni istisno qiladi.
* **timeout connect, timeout client, timeout server** Ulanishning(connection) turli bosqichlari (connect(ulanish), client, server) uchun kutish vaqtini(timeout) o'rnatadi.
* **errorfile** Maxsus HTTP xato(error) kodlari uchun maxsus(custom) xato fayllarini belgilaydi va foydalanuvchi tajribasini(user experience) yaxshilash uchun maxsus xato sahifalarini taqdim etadi.

## HAProxy load balancer konfiguratsiya qilish.

HAProxy-dan foydalangan holda load-balancer sozlashda ikkita turdagi nodelar(server) aniqlanishi kerak: **frontend** va **backend**. **Frontend** - bu HAProxy ulanishlarni tinglaydigan(listen) node. Backend nodelari HAProxy so'rovlarini yo'naltirishi mumkin bo'lgan nodelardir. Uchinchi node turi, statistik node load-balancerni va boshqa ikkita nodeni kuzatish(monitoring) uchun ishlatilishi mumkin.

**1.** `nano` matn muharririda `/etc/haproxy/haproxy.cfg` faylini oching va frontend qism uchun konfiguratsiyani qo'shing:

```bash
sudo nano /etc/haproxy/haproxy.cfg
```

```bash filename="/etc/haproxy/haproxy.cfg" /frontend/
frontend haproxynode
    bind *:80
    mode http
    default_backend backendnodes
```

Ushbu konfiguratsiya kiruvchi **HTTP** trafigini **80**-portda tinglaydigan(listen) frontendni yaratadi va default ushbu trafikni **backendnodes** deb nomlangan backendga yuboradi. Ushbu sozlash sizga turli serverlar yoki servicelar o'rtasida trafik qanday yo'naltirilishi va load balancingni nazorat qilish uchun qoidalar, ACL (**A**ccess **C**ontrol **L**ists), yoki boshqa shartlarni qo'shimcha aniqlash imkonini beradi. Bu konfiguratsiya bloki **80**-portdagi barcha tarmoq interfeyslari bilan bog'langan **haproxynode** nomli frontend nodeni belgilaydi. U HTTP ulanishlarini tinglaydi (boshqa maqsadlarda TCP rejimidan foydalanish mumkin) va u backendning backend nodelaridan foydalanadi.

**2.** backend konfiguratsiyasini qo'shing:

```bash filename="/etc/haproxy/haproxy.cfg" /balance/ /server/
backend backendnodes
    balance roundrobin
    option forwardfor
    http-request set-header X-Forwarded-Port %[dst_port]
    http-request add-header X-Forwarded-Proto https if { ssl_fc }
    option httpchk HEAD / HTTP/1.1\r\nHost:localhost
    server node1 185.168.1.21:3000 check
    server node2 185.168.1.22:3000 check
```

Bu backend nodelarni belgilaydi va bir nechta konfiguratsiya variantlarini belgilaydi. Keling backend configuratsiyani ko'rib chiqamiz.

* **`backend backendnodes`** HAProxy konfiguratsiyasida odatda kiruvchi so'rovlarni bajaradigan serverlar yoki nodelar guruhini ifodalovchi backend qismini belgilaydi.
* **`balance roundrobin`** Kiruvchi so'rovlarni backenddagi mavjud serverlar o'rtasida teng taqsimlab, load balancing algoritmini round-robinga o'rnatadi. Har bir keyingi so'rov navbatdagi keyingi serverga yuboriladi.

* **`option forwardfor`** **HAProxy**-ga serverlarga yuborilgan **HTTP** so'rovlariga **X-Forwarded-For** headerini qo'shish imkonini beradi. Ushbu headerda asl clientning **IP**-manzili mavjud bo'lib, backend serverlariga kelib chiqqan clientni aniqlash imkonini beradi.

* **`http-request set-header X-Forwarded-Port %[dst_port]`** Backend serverlariga yuborilgan HTTP so'rovlarida **X-Forwarded-Port** headerini o'rnatadi. U so'rov yuborilgan HAProxy serverining destination portini o'z ichiga oladi.

* **`http-request add-header X-Forwarded-Proto https if { ssl_fc }`** HAProxy'ga kiruvchi so‘rov **HTTPS**(ssl_fc) orqali qabul qilingan bo‘lsa, **X-Forwarded-Proto** headerini HTTP so‘rovlariga qo‘shadi. Ushbu header client tomonidan so'rovni amalga oshirishda foydalaniladigan protokolni ko'rsatadi.
* **`option httpchk HEAD / HTTP/1.1\r\nHost:localhost`** Backend serverlari uchun HTTP health checkni sozlaydi. U serverlarning sog'lig'ini tekshirish(health check) uchun HTTP versiyasi va **Host** headeri **localhost** ga o'rnatilgan holda root(ildiz) yo'liga ("`/`") **HTTP HEAD** so'rovini yuboradi. HAProxy ushbu tekshiruvdan kiruvchi so'rovlarni ko'rib chiqish uchun server mavjudligini aniqlash uchun foydalanadi.

* **`server node1 185.168.1.21:3000 check` va `server node2 185.168.1.22:3000 check`** Backend **backendnodes** ichida ikkita serverni (node1 va node2) belgilaydi. Har bir server IP manzili va port raqami (mos ravishda 185.168.1.21:3000 va 185.168.1.22:3000) bilan aniqlanadi. Tekshirish(check) kalit so'zi HAProxy sozlangan health check metodi (**option httpchk**) yordamida ushbu serverlarning sog'lig'ini muntazam ravishda tekshirishi kerakligini bildiradi. Ushbu serverlar kiruvchi so'rovlarni bajarishga tayyor.

Umumiy qilib aytganda HAProxy-dagi ushbu backend konfiguratsiyasi headerlar (**X-Forwarded-For**, **X-Forwarded-Port**, **X-Forwarded-Proto**), health check va ikkita backend serverlari uchun maxsus sozlamalar bilan load balancer muhitini (roundrobin) o'rnatadi. node1 va node2 kiruvchi trafikni boshqarish uchun tayyor serverlar(backend serverlar).
