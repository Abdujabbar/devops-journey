import { Callout } from "nextra-theme-docs";

# Patroni va HAProxy yordamida Highly Available PostgreSQL clusterini yaratish

![postgres-cluster](/images/tutorials/database/postgres-cluster/banner.png)

## Kirish

Bugungi raqamli landshaftda ma'lumotlar bazalarining high availability va ishonchliligini ta'minlash barcha o'lchamdagi korxonalar va tashkilotlar uchun muhim ahamiyatga ega. O'zining mustahkamligi, scalability va extensibility bilan mashhur bo'lgan PostgreSQL ko'plab muhim application uchun asos bo'lib xizmat qiladi. PostgreSQL ma'lumotlar bazalarining ishlash muddati va barqarorligini oshirish uchun highly available bo'lgan klaster arxitekturasini o'rnatishga ehtiyoj seziladi.

Ushbu texnik qo'llanma sizga **Patroni** va **HAProxy**-dan foydalangan holda highly available bo'lgan PostgreSQL klasterini yaratish jarayonini o'tkazishga qaratilgan. Patroni, PostgreSQL uchun high-leveldagi Python orkestratori postgreSQL klasterlarini o'zgartirish va replikatsiya kabi vazifalarni avtomatlashtirish orqali boshqarishni soddalashtiradi. HAProxy, ko'p qirrali va kuchli load balancer, clientlar ulanishlarini bir nechta PostgreSQL misollari bo'ylab taqsimlashni osonlashtiradi, resurslardan samarali foydalanish va uzluksiz uzilishni ta'minlaydi.

Ushbu qo'llanmaning oxirida siz bardoshli PostgreSQL klaster arxitekturasini qanday loyihalash, amalga oshirish va qo'llab-quvvatlash haqida  tushunchaga ega bo'lasiz, bu sizga ma'lumotlar bazasi infratuzilmangizda yuqori darajadagi mavjudlik(high availability) va xatolarga chidamlilik(tolerance) talablarini qondirish imkonini beradi. Keling, potentsial nosozliklarga chidamli va qimmatli ma'lumotlaringizga uzluksiz kirishni ta'minlaydigan mustahkam PostgreSQL klasterini yaratish yo'lida ushbu sayohatni boshlaylik.

## Ishni Boshlash

Ushbu amaliyotda biz **Ubuntu 20.04** serverlarda patroni, etcd, pgbouncer va HAProxy yordamida PostgreSQL cluster yaratamiz. 

**Patroni** - bu PostgreSQL klasterlarini boshqarishni avtomatlashtirish uchun mo'ljallangan open-source tool bo'lib, high availability va barqarorlikni ta'minlashga qaratilgan. U PostgreSQL instancelarini bir nechta nodelar bo'ylab joylashtirish va ularga xizmat ko'rsatishni, ularni doimiy ravishda  helath check qilib kuzatib borish va nosozliklar yoki jiddiy muammolar yuzaga kelganda avtomatlashtirilgan uzilish protseduralarini tartibga solish orqali soddalashtiradi.

Patronining asosiy xususiyatlari quyidagilardan iborat: avtomatlashtirilgan uzilish, taqsimlangan consensus algoritmlaridan foydalangan holda leaderni tanlash, markazlashtirilgan konfiguratsiyani boshqarish, **pgBouncer** va **HAProxy** kabi ekotizim toollari bilan uzluksiz integratsiya va sozlash uchun kengaytirilganlik.

**PgBouncer** - bu PostgreSQL ma'lumotlar bazalari uchun lightweight connection pooler. U client applicationlari va PostgreSQL ma'lumotlar bazasi serverlari o'rtasida joylashgan bo'lib, ma'lumotlar bazasi ulanishlarini boshqaradigan va optimallashtiradigan vositachi sifatida ishlaydi.U ma'lumotlar bazasi arxitekturalarida, ayniqsa ulanishning uzilishi yoki talab qilinadigan ish yuklari bo'lgan muhitlarda muhim komponent bo'lib xizmat qiladi, ma'lumotlar bazasi resurslaridan samarali foydalanish va client applicationlari uchun javob berish qobiliyatini oshiradi.

**etcd** - yuqori ishonchli distributed systemlarni yaratish uchun mo'ljallangan distributed key-value store. CoreOS tomonidan ishlab chiqilgan bo'lib, u barqarorlik va nosozliklarga chidamliligini ta'minlagan holda ma'lumotlarni machinelar klasterida saqlashning ishonchli usulini ta'minlaydi. Oddiy API va mustahkam dizayni bilan etcd distributed applicationlarni ishlab chiqishni soddalashtiradi va dinamik muhitda muammosiz masshtablash va moslashuvchanlikni ta'minlaydi.

<Callout type="info" emoji="">
Ushbu amaliyotda biz production uchun yuqorida darajada yozilgan [github.com/vitabaks/postgresql_cluster](https://github.com/vitabaks/postgresql_cluster) **Ansible** playbookdan foydalanamiz. Ushbu amaliyot uchun moslangan versiyasi [github.com/devops-journey-uz/postgresql_cluster](https://github.com/devops-journey-uz/postgresql_cluster)

Ushbu Ansible playbook qo'llab quvvvatlaydigan serverlar
* **Debian:** 10, 11, 12
* **Ubuntu:** 18.04, 20.04, 22.04
* **CentOS:** 7, 8
* **CentOS Stream:** 8, 9
* **Oracle Linux:** 7, 8, 9
* **Rocky Linux:** 8, 9
* **AlmaLinux:** 8, 9
</Callout>

## Arxitekura

Ushbu amaliyotda quyidagi rasmdagi arxitekturani quramiz. Bizda bitta **etcd** va bitta **load-balancer** serverimiz bo'ladi. Ikkita postgres replica va bitta masterimiz bo'ladi.

![postgres-cluster](/images/tutorials/database/postgres-cluster/architecture.png)


Quyidagi rasmda esa network arxitekturamiz.

![postgres-cluster](/images/tutorials/database/postgres-cluster/network-architecture.png)

Bizda Postgresql clusterimiz uchun **db-network**kimiz bor uni ichida esa **db-subnet** nomli **172.20.0.0/16** IP rangelik subnetimiz bor. Barcha serverlarimiz bir biriga internal IP bilan bo'glanib ishlaydi, bitta load-balancer serverimizda static(public) IP address bo'ladi holos. Agar siz Azure ishlatsangiz [Azureda Network sozlash](https://devops-journey.uz/guides/cloud/azure-network-sozlash) amaliyotidan quyidagi networkni qurib olishingiz mumkin.

## Environment sozlash

Ushbu amaliyotni cloud va on-primise environmentda qilishimiz mumkin. Buning uchun bizga bitta network va subnet kerak bo'ladi serverlarimiz internal IP bilan bog'lanishi uchun. Minimum 6ta server kerak bo'ladi.

Ushbu amaliyot uchun ishlatilgan server IP manzillarimiz namuna hisoblanadi qo'llanmada chalg'imasligingiz uchun.

| RAM            | CPU           | Xotira       | Internal IP  |  Server Nomi         |
| -------------- | ------------- |------------- | ------------ | -------------------- |
| 8GB            | 2vCPU 2 core  | 100GB        | 170.20.0.4   | etcd                 |
| 8GB            | 2vCPU 2 core  | 50GB         | 170.20.0.5   | load-balancer        |
| 8GB            | 2vCPU 2 core  | 50GB         | 170.20.0.6   | node1                |
| 8GB            | 2vCPU 2 core  | 50GB         | 170.20.0.7   | node2                |
| 8GB            | 2vCPU 2 core  | 50GB         | 170.20.0.8   | node3                |
| 4GB            | 2vCPU 2 core  | 50GB         | 170.20.0.9   | ansible              |


## Network sozlash

Ushbu amaliyotda birinchi qiladigan ishimiz bu network sozlashdir keling ishni network sozlashdan boshlaymiz.

Siz quyidagidek network sozlab olishingiz kerak bo'ladi barcha serverlar bitta networkda bitta subnetda bo'lishi va bir bir bilan internal IP bilan bog'lanib ishlashi kerak faqat load-balancer serverimizda static(public) IP address bo'ladi ya'ni tashqaridan ulana olish uchun. Ushnu network arxitektura PostgreSQL clusterimizni kengaytirishda ham ko'p qulaylik beradi.

![postgres-cluster](/images/tutorials/database/postgres-cluster/network-architecture.png)

Ushbu network arxitekturani on-primise va cloudda ham sozlashingiz mumkin. Agar siz **Microsoft Azure** ishlatsangiz [Azure Network sozlash](https://devops-journey.uz/guides/cloud/azure-network-sozlash) qo'llanmaisdan quyidagi networkni sozlab olishingiz mumkin.

## Ansible server sozlash

Network sozlab olganimizdan keyin shu networkda bitta ansible server yaratib olamiz. Barcha ishni shu ansible server orqali bajaramiz va ansible server boshqa serverlarga internal IP bilan ulana olishi kerak.

Ansible serverimizga ansible o'rnatimiz olamiz.

```bash
sudo apt update && sudo apt upgrade -y
```

```bash
sudo apt-get install software-properties-common python3-pip sshpass git
sudo apt-add-repository ppa:ansible/ansible
```
```bash
sudo apt-get update
sudo apt-get install ansible
```

Ansible o'rnatib olganimizdan keyin Ansible serverimizda ssh key generatsiya qilib barcha serverlarga root user bilann ssh orqali ulanishini sozlab chiqishimiz kerak. Buning uchun ansible servermizda ssh key generatsiya qilamiz va public keyni ansible serverimiz authorized_keys'gan qo'shib qo'yamiz. Ansible serverimizdagi public ssh keyimizni esa barcha serverlarda root userga kirib authorized_keys'ga qo'shib chiqamiz va har bir serverga root userdan ansible serverdan ulanib ko'ramiz.

**1->** Ansible serverdan

```bash
ssh-keygen -f ~/.ssh/db-cluster
cd ~/.ssh/
cat db-cluster.pub >> authorized_keys
```

Ansible serverdagi **db-cluster.pub** keyni nusxalab olamiz.

```bash
cd ~/.ssh/
cat db-cluster.pub
```

**2->** Boshqa serverlarda. Ansible boshqa serverlarga root user bilan kira olishi kerak. barcha serverlarda **db-cluster.pub** keyimizni serverlar authorized_keys'ga qo'shib chiqganimzidan keyin internal ip bilan ssh orqali bog'lanishni tekshirib ko'ramiz.

```bash
sudo su
```
```bash
cat >> ~/.ssh/authorized_keys <<EOF
ssh-rsa ssh-keyimizni joylashtiramiz
EOF
```

## Cluster yaratish

Ansible serverimizni sozlab boshqa sereverlar bilan ssh ulanishni bog'laganimizdan keyin Postgresql cluster yaratishni boshlasak bo'ladi. [github.com/vitabaks/postgresql_cluster](https://github.com/vitabaks/postgresql_cluster) ansible playbookni ansible serverimizda git clone qilib olamiz va o'zimizga moslab configuratsiya qilib olamiz.

**1->** Ansible serverimizda ansible playbookni git clone qilib olamiz.

```bash
git clone https://github.com/vitabaks/postgresql_cluster.git
cd postgresql_cluster/
```

**2->** `inventory` konfiguratsiya fayliga serverlarimiz internal IP addrslarini qo'shib chiqamiz.

| server         | Internal IP    |
| -------------- | -------------- |
| etcd           | 170.20.0.4     |
| load-balancer  | 170.20.0.5     |
| node1          | 170.20.0.6     |
| node2          | 170.20.0.7     |
| node3          | 170.20.0.8     |


![postgres-cluster](/images/tutorials/database/postgres-cluster/inventory.png)

**3->** `postgresql_cluster/vars/system.yml` konfiguratsiya faylidan timezoneni belgilaymiz.

![postgres-cluster](/images/tutorials/database/postgres-cluster/timezone.png)

**4->** `postgresql_cluster/vars/main.yml` konfiguratsiya faylidan postgres pgbouncer parollarnini belgilaymiz.

![postgres-cluster](/images/tutorials/database/postgres-cluster/password.png)

![postgres-cluster](/images/tutorials/database/postgres-cluster/pgbouncer1.png)

**3->** Barchasini o'zimizga moslab sozlab olganimizdan keyin barcha serverlarga ulanish bor yoki yo'qligini tekshiramiz.

![postgres-cluster](/images/tutorials/database/postgres-cluster/ping.png)